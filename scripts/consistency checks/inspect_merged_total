#!/usr/bin/env python3
"""
Goal:
    Generate a human-readable validation report from pre-computed statistics.

Input:
    - JSON file: outputs/Tables/merged_panel_statistics.json
      (generated by compute_panel_statistics script)

Process:
    - Reads statistics from JSON
    - Formats them into a comprehensive, readable text report

Output:
    - Text report: outputs/Tables/merged_panel_validation.txt
    - Console summary of key findings
"""

import json
import sys
from pathlib import Path
from datetime import datetime

# Define paths
ROOT_DIR = Path(__file__).resolve().parents[2]
INPUT_JSON = ROOT_DIR / "outputs" / "Tables" / "merged_panel_statistics.json"
OUTPUT_TXT = ROOT_DIR / "outputs" / "Tables" / "merged_panel_validation.txt"


def format_number(num):
    """Format number with thousands separators."""
    if isinstance(num, (int, float)):
        return f"{num:,}"
    return str(num)


def format_percentage(numerator, denominator):
    """Format as percentage."""
    if denominator == 0:
        return "0.00%"
    return f"{(numerator / denominator * 100):.2f}%"


def main():
    """Main function to generate validation report from JSON."""
    
    print("\n" + "=" * 80)
    print("MERGED PANEL DATASET - VALIDATION REPORT GENERATION")
    print("=" * 80)
    print()
    
    # Check if JSON file exists
    if not INPUT_JSON.exists():
        print(f"ERROR: Statistics file not found: {INPUT_JSON}")
        print()
        print("Please run the statistics computation script first:")
        print("  python scripts/consistency\\ checks/compute_panel_statistics")
        sys.exit(1)
    
    # Load statistics
    print(f"Loading statistics from: {INPUT_JSON}")
    with open(INPUT_JSON, 'r') as f:
        stats = json.load(f)
    
    print("✓ Statistics loaded successfully")
    print(f"Writing report to: {OUTPUT_TXT}\n")
    
    # Generate report
    with open(OUTPUT_TXT, 'w') as f:
        # Header
        f.write("=" * 80 + "\n")
        f.write("MERGED PANEL DATASET VALIDATION REPORT\n")
        f.write("=" * 80 + "\n")
        f.write(f"Report generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write(f"Source file: {stats['metadata']['file']}\n")
        f.write(f"Data computed: {stats['metadata']['generated']}\n")
        f.write("=" * 80 + "\n\n")
        
        # 1. Dataset Dimensions
        print("1. Dataset dimensions...")
        f.write("1. DATASET DIMENSIONS\n")
        f.write("-" * 80 + "\n")
        f.write(f"Total rows: {format_number(stats['metadata']['total_rows'])}\n")
        f.write(f"Total columns: {stats['metadata']['total_columns']}\n")
        f.write(f"Number of row groups: {format_number(stats['metadata']['num_row_groups'])}\n")
        f.write("\n")
        
        # 2. Column Information
        print("2. Column information...")
        f.write("2. COLUMN INFORMATION\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Column Name':<50} {'Data Type':<30}\n")
        f.write("-" * 80 + "\n")
        
        for col_name in stats['columns']['names']:
            col_type = stats['columns']['types'].get(col_name, 'Unknown')
            f.write(f"{col_name:<50} {col_type:<30}\n")
        
        f.write(f"\nNumeric columns: {stats['columns']['num_numeric']}\n")
        f.write("\n")
        
        # 3. Unique Values
        print("3. Unique values...")
        f.write("3. UNIQUE VALUES\n")
        f.write("-" * 80 + "\n")
        f.write(f"Pixel identifier: {stats['pixels']['pixel_identifier']}\n")
        f.write(f"Unique pixels: {format_number(stats['pixels']['unique_pixels'])}\n")
        f.write(f"Unique years: {stats['years']['num_unique_years']}\n")
        f.write(f"Year range: {min(stats['years']['unique_years'])} - {max(stats['years']['unique_years'])}\n")
        f.write("\n")
        
        # 4. Rows Per Year
        print("4. Rows per year...")
        f.write("4. ROWS PER YEAR\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Year':<10} {'Count':<20} {'Percentage':<15}\n")
        f.write("-" * 80 + "\n")
        
        total_rows = stats['metadata']['total_rows']
        for year in sorted(stats['years']['unique_years']):
            count = stats['years']['year_counts'].get(str(year), 0)
            pct = format_percentage(count, total_rows)
            f.write(f"{year:<10} {format_number(count):<20} {pct:<15}\n")
        f.write("\n")
        
        # 5. Uniqueness Check
        print("5. Uniqueness check...")
        f.write("5. UNIQUENESS CHECK\n")
        f.write("-" * 80 + "\n")
        
        unique_info = stats['uniqueness']
        f.write(f"Unique pixels: {format_number(unique_info['unique_pixels'])}\n")
        f.write(f"Unique years: {unique_info['unique_years']}\n")
        f.write(f"Expected rows (pixels × years): {format_number(unique_info['expected_rows'])}\n")
        f.write(f"Actual rows: {format_number(unique_info['actual_rows'])}\n")
        
        if unique_info['is_unique']:
            f.write("\n✓ All (pixel, year) pairs are unique\n")
            f.write(f"  ({format_number(unique_info['actual_rows'])} unique combinations)\n")
        else:
            f.write(f"\n✗ WARNING: Potential duplicate or missing (pixel, year) pairs!\n")
            f.write(f"  Difference: {format_number(unique_info['difference'])} rows\n")
            if unique_info['actual_rows'] > unique_info['expected_rows']:
                f.write(f"  → More rows than expected (possible duplicates)\n")
            else:
                f.write(f"  → Fewer rows than expected (missing combinations)\n")
        f.write("\n")
        
        # 6. Missing Values
        print("6. Missing values analysis...")
        f.write("6. MISSING VALUES ANALYSIS\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Column Name':<50} {'Missing':<20} {'Percentage':<15}\n")
        f.write("-" * 80 + "\n")
        
        missing_counts = stats['missing_values']
        cols_with_missing = 0
        
        for col in stats['columns']['names']:
            missing = missing_counts.get(col, 0)
            pct = format_percentage(missing, total_rows)
            
            if missing > 0:
                cols_with_missing += 1
            
            f.write(f"{col:<50} {format_number(missing):<20} {pct:<15}\n")
        
        f.write(f"\nSummary: {cols_with_missing} columns have missing values\n")
        f.write("\n")
        
        # 7. Numeric Statistics
        print("7. Numeric column statistics...")
        f.write("7. NUMERIC COLUMN STATISTICS\n")
        f.write("-" * 80 + "\n")
        f.write(f"{'Column Name':<40} {'Min':<18} {'Max':<18} {'Mean':<18}\n")
        f.write("-" * 80 + "\n")
        
        numeric_stats = stats['numeric_statistics']
        
        for col in stats['columns']['numeric_columns']:
            if col in numeric_stats:
                col_stats = numeric_stats[col]
                min_val = col_stats['min']
                max_val = col_stats['max']
                mean_val = col_stats['mean']
                
                # Format values
                if min_val is not None and isinstance(min_val, (int, float)):
                    min_str = f"{min_val:.6f}" if isinstance(min_val, float) else str(min_val)
                else:
                    min_str = "N/A"
                
                if max_val is not None and isinstance(max_val, (int, float)):
                    max_str = f"{max_val:.6f}" if isinstance(max_val, float) else str(max_val)
                else:
                    max_str = "N/A"
                
                if mean_val is not None and isinstance(mean_val, (int, float)):
                    mean_str = f"{mean_val:.6f}" if isinstance(mean_val, float) else str(mean_val)
                else:
                    mean_str = "N/A"
                
                f.write(f"{col:<40} {min_str:<18} {max_str:<18} {mean_str:<18}\n")
        
        f.write(f"\nTotal numeric columns: {len(numeric_stats)}\n")
        f.write("\n")
        
        # 8. Static Variables
        print("8. Static variables...")
        f.write("8. STATIC VARIABLES (Constant Across Years)\n")
        f.write("-" * 80 + "\n")
        
        static_info = stats['static_variables']
        
        if not static_info['enabled']:
            f.write("Static variable detection was disabled during computation.\n")
            f.write("To enable, set CHECK_STATIC_VARS=True in compute_panel_statistics script.\n")
        else:
            f.write(f"Total static variables found: {static_info['count']}\n\n")
            
            if static_info['count'] > 0:
                f.write("Static columns (constant across all years for each pixel):\n")
                for var in static_info['variables']:
                    f.write(f"  - {var}\n")
            else:
                f.write("No static variables detected.\n")
                f.write("All feature columns vary across years within at least some pixels.\n")
        
        f.write("\n")
        
        # Footer
        f.write("=" * 80 + "\n")
        f.write("END OF REPORT\n")
        f.write("=" * 80 + "\n")
    
    print("✓ Report generation complete!")
    
    # Print summary to console
    print("\n" + "=" * 80)
    print("VALIDATION SUMMARY")
    print("=" * 80)
    print(f"Total rows: {format_number(stats['metadata']['total_rows'])}")
    print(f"Total columns: {stats['metadata']['total_columns']}")
    print(f"Numeric columns: {stats['columns']['num_numeric']}")
    print(f"Unique pixels: {format_number(stats['pixels']['unique_pixels'])}")
    print(f"Unique years: {stats['years']['num_unique_years']} (range: {min(stats['years']['unique_years'])}-{max(stats['years']['unique_years'])})")
    
    # Uniqueness
    if stats['uniqueness']['is_unique']:
        print("✓ All (pixel, year) pairs are unique")
    else:
        print("✗ WARNING: Potential uniqueness issues detected!")
    
    # Missing values
    cols_with_missing = sum(1 for v in stats['missing_values'].values() if v > 0)
    print(f"Columns with missing values: {cols_with_missing}/{stats['metadata']['total_columns']}")
    
    # Static variables
    if stats['static_variables']['enabled']:
        print(f"Static variables: {stats['static_variables']['count']}")
    else:
        print("Static variables: Not computed")
    
    print("\n" + "=" * 80)
    print(f"Full report saved to: {OUTPUT_TXT}")
    print("=" * 80)


if __name__ == "__main__":
    main()
