import rasterio
import matplotlib.pyplot as plt
import numpy as np

# Load the GeoTIFF
with rasterio.open('viirs_pa_embed63_sa_10km_meanreduced.tif') as src:
    num_bands = src.count
    print(f"Total bands in file: {num_bands}")
    
    # Based on the debugging output, let's use the correct bands:
    # Band 64 seems to have actual night lights data
    # Band 65 seems to have protected areas data
    night_lights = src.read(64)  # Band 64 - actual night lights data
    pa_mask = src.read(65)       # Band 65 - protected areas mask
    
    # Load all bands to check which ones have actual data
    all_bands = []
    for i in range(1, num_bands + 1):
        band_data = src.read(i)
        all_bands.append((i, band_data))

    # Find bands with actual variation (not all zeros or constants)
    useful_bands = []
    for band_num, band_data in all_bands:
        band_clean = np.where(np.isnan(band_data), 0, band_data)
        variation = band_clean.max() - band_clean.min()
        
        if variation > 1e-10:  # Check for very small variations (numerical precision)
            useful_bands.append((band_num, band_clean))
            print(f"Band {band_num}: min={band_clean.min():.6f}, max={band_clean.max():.6f}, variation={variation:.2e}")
        else:
            # Check if it's exactly zero or some other constant
            constant_val = band_clean.min()
            if constant_val == 0:
                print(f"Band {band_num}: all zeros")
            else:
                print(f"Band {band_num}: constant value = {constant_val:.6f}")

    # Use the useful bands for visualization
    embedding_bands = [band_data for _, band_data in useful_bands if _ not in [64, 65]]  # Exclude our main data bands
    
    # Handle NaN values and print detailed debugging info
    night_lights_clean = np.where(np.isnan(night_lights), 0, night_lights)

# Print detailed data info for debugging
print(f"Night lights shape: {night_lights.shape}")
print(f"Night lights data type: {night_lights.dtype}")
print(f"Original - min: {night_lights.min()}, max: {night_lights.max()}")
print(f"Original - NaN count: {np.isnan(night_lights).sum()}")
print(f"Cleaned - min: {night_lights_clean.min()}, max: {night_lights_clean.max()}")
print(f"Cleaned - non-zero values: {np.count_nonzero(night_lights_clean)}")
print(f"Cleaned - unique values: {len(np.unique(night_lights_clean))}")
print(f"Number of embedding bands: {len(embedding_bands)}")

# Check if data has variation
if night_lights_clean.max() == night_lights_clean.min():
    print("WARNING: Night lights data has no variation - all values are identical!")
else:
    print(f"Night lights data range: {night_lights_clean.min():.6f} to {night_lights_clean.max():.6f}")

# Create a single overlaid plot
plt.figure(figsize=(15, 10))

# Plot night lights as the base layer
if night_lights_clean.max() > night_lights_clean.min():
    # Data has variation, use percentile-based normalization
    non_zero_mask = night_lights_clean > 0
    if np.any(non_zero_mask):
        vmin = np.percentile(night_lights_clean[non_zero_mask], 5)
        vmax = np.percentile(night_lights_clean, 95)
    else:
        vmin = night_lights_clean.min()
        vmax = night_lights_clean.max()
    
    print(f"Using vmin={vmin:.6f}, vmax={vmax:.6f} for night lights")
    plt.imshow(night_lights_clean, cmap='viridis', vmin=vmin, vmax=vmax)
else:
    print("WARNING: Night lights data has no variation!")
    plt.imshow(night_lights_clean, cmap='viridis')

# Overlay protected areas
plt.imshow(pa_mask, cmap='Greens', alpha=0.4, vmin=0, vmax=1)

# Note about embedding bands
if len(embedding_bands) == 0:
    print("Note: No useful embedding bands found in bands 1-63. They all contain constant values.")
    print("This suggests the embedding data may be stored elsewhere or not properly saved.")
else:
    print(f"Found {len(embedding_bands)} embedding bands with variation")

plt.title('Night Lights + Protected Areas + Embedding Bands - South America', fontsize=14, pad=20)
plt.axis('off')

# Add legend for the two visible layers
from matplotlib.patches import Patch
legend_elements = [
    Patch(facecolor='green', alpha=0.4, label='Protected Areas'),
    Patch(facecolor='yellow', alpha=0.8, label='Night Lights (High Intensity)')
]

plt.legend(handles=legend_elements, loc='upper right', framealpha=0.8)

plt.tight_layout()
plt.show()

# Print statistics for embedding bands
print("\nEmbedding bands statistics:")
for i, embed_band in enumerate(embedding_bands):
    embed_clean = np.where(np.isnan(embed_band), 0, embed_band)
    print(f"Band {i+3}: min={embed_clean.min():.4f}, max={embed_clean.max():.4f}, mean={embed_clean.mean():.4f}")