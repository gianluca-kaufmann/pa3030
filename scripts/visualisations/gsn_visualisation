#!/usr/bin/env python3
"""
Global Safety Net (GSN) Visualization for South America

This script creates visualizations of the Global Safety Net raster masks
generated from the preprocessing script. Each GSN layer is visualized
individually and in combination.

Inputs: GeoTIFF masks from data/output_masks/:
- gsn_climate_stabilisation_areas_mask_1km.tif
- gsn_high_biodiversity_areas_mask_1km.tif
- gsn_intact_wilderness_areas_mask_1km.tif
- gsn_potential_wildlife_corridors_mask_1km.tif
- gsn_terrestrial_ecoregions_mask_1km.tif

Outputs: Individual maps, combined overview, and statistics plots
saved in outputs/Figures/gsn_vis.
"""

import numpy as np
import rasterio
import matplotlib.pyplot as plt
from pathlib import Path
import warnings
from matplotlib.colors import ListedColormap, BoundaryNorm
from matplotlib.patches import Patch

warnings.filterwarnings('ignore')

# Paths
PROJECT_ROOT = Path("/Users/gianluca/Desktop/Master's Thesis/code")
DATA_DIR = PROJECT_ROOT / "data"
MASKS_DIR = DATA_DIR / "output_masks"
OUTPUT_DIR = PROJECT_ROOT / "outputs/Figures/gsn_vis"
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

# GSN layer definitions
GSN_LAYERS = {
    'climate_stabilisation_areas': {
        'file': 'gsn_climate_stabilisation_areas_mask_1km.tif',
        'title': 'Climate Stabilisation Areas',
        'color': '#1B5E20',  # Dark Green
        'description': 'Areas critical for climate stabilization'
    },
    'high_biodiversity_areas': {
        'file': 'gsn_high_biodiversity_areas_mask_1km.tif',
        'title': 'High Biodiversity Areas',
        'color': '#1B5E20',  # Dark Green
        'description': 'Areas with exceptional biodiversity'
    },
    'intact_wilderness_areas': {
        'file': 'gsn_intact_wilderness_areas_mask_1km.tif',
        'title': 'Intact Wilderness Areas',
        'color': '#1B5E20',  # Dark Green
        'description': 'Large intact wilderness areas'
    },
    'potential_wildlife_corridors': {
        'file': 'gsn_potential_wildlife_corridors_mask_1km.tif',
        'title': 'Potential Wildlife Corridors',
        'color': '#1B5E20',  # Dark Green
        'description': 'Potential corridors for wildlife movement'
    },
    'terrestrial_ecoregions': {
        'file': 'gsn_terrestrial_ecoregions_mask_1km.tif',
        'title': 'Terrestrial Ecoregions',
        'color': '#9B59B6',  # Vibrant Purple (will use magenta palette)
        'description': 'Distinct terrestrial ecoregions',
        'is_categorical': True
    }
}


def load_gsn_data():
    """Load all GSN raster masks."""
    print("üìÅ Loading Global Safety Net raster masks...")
    
    all_data = {}
    
    for layer_key, layer_info in GSN_LAYERS.items():
        tif_path = MASKS_DIR / layer_info['file']
        
        if not tif_path.exists():
            print(f"   ‚ö†Ô∏è File not found: {tif_path.name}")
            continue
            
        try:
            with rasterio.open(tif_path) as src:
                data = src.read(1).astype(np.uint8)
                
                # Get basic stats
                total_pixels = data.size
                
                if layer_info.get('is_categorical', False):
                    # For categorical data (ecoregions), count unique values
                    unique_values = np.unique(data)
                    unique_values = unique_values[unique_values > 0]  # Exclude 0 (no data)
                    protected_pixels = np.sum(data > 0)
                    protected_percentage = (protected_pixels / total_pixels) * 100
                    
                    print(f"   ‚úÖ {layer_info['title']}: {len(unique_values)} unique ecoregions, "
                          f"{protected_pixels:,} pixels ({protected_percentage:.2f}%)")
                else:
                    # For binary data, count 1s
                    protected_pixels = np.sum(data == 1)
                    protected_percentage = (protected_pixels / total_pixels) * 100
                    
                    print(f"   ‚úÖ {layer_info['title']}: {protected_pixels:,} protected pixels ({protected_percentage:.2f}%)")
                
                all_data[layer_key] = {
                    'data': data,
                    'src_profile': src.profile,
                    'file_path': tif_path,
                    'stats': {
                        'total_pixels': total_pixels,
                        'protected_pixels': protected_pixels,
                        'protected_percentage': protected_percentage
                    },
                    'is_categorical': layer_info.get('is_categorical', False)
                }
                
        except Exception as e:
            print(f"   ‚ùå Error loading {layer_key}: {e}")
            continue
    
    if not all_data:
        print("   ‚ùå No data loaded successfully")
        return None
    
    print(f"   üìä Successfully loaded {len(all_data)} GSN layers")
    return all_data


def create_individual_maps(all_data):
    """Create individual maps for each GSN layer."""
    if all_data is None:
        return
    
    print("üé® Creating individual GSN layer maps...")
    
    for layer_key, layer_info in GSN_LAYERS.items():
        if layer_key not in all_data:
            continue
            
        data_info = all_data[layer_key]
        data = data_info['data']
        stats = data_info['stats']
        is_categorical = data_info.get('is_categorical', False)
        
        fig, ax = plt.subplots(figsize=(12, 10))
        
        if is_categorical:
            # For ecoregions, use magenta color palette
            unique_values = np.unique(data)
            unique_values = unique_values[unique_values > 0]  # Exclude 0
            
            # Create magenta-based colormap
            n_colors = len(unique_values)
            if n_colors > 0:
                # Generate colors from light magenta to dark magenta
                colors = plt.cm.magma(np.linspace(0.2, 0.9, n_colors))
                cmap = ListedColormap(['white'] + colors.tolist())
                
                # Create normalization
                bounds = [0] + unique_values.tolist() + [unique_values.max() + 1]
                norm = BoundaryNorm(bounds, cmap.N)
                
                im = ax.imshow(data, cmap=cmap, norm=norm, interpolation='nearest')
                
                # Add colorbar for ecoregions
                cbar = plt.colorbar(im, ax=ax, shrink=0.6)
                cbar.set_label('Ecoregion ID', rotation=270, labelpad=15)
                
                stats_text = (f"Unique ecoregions: {len(unique_values)}\n"
                             f"Covered pixels: {stats['protected_pixels']:,}\n"
                             f"Coverage: {stats['protected_percentage']:.2f}%")
            else:
                # Fallback if no unique values
                im = ax.imshow(data, cmap='Greys', vmin=0, vmax=1, interpolation='nearest')
                stats_text = "No ecoregion data found"
        else:
            # For binary data, use layer-specific color
            colors = ['white', layer_info['color']]
            cmap = ListedColormap(colors)
            
            im = ax.imshow(data, cmap=cmap, vmin=0, vmax=1, interpolation='nearest')
            
            stats_text = (f"Protected pixels: {stats['protected_pixels']:,}\n"
                         f"Coverage: {stats['protected_percentage']:.2f}%")
        
        ax.set_title(f"{layer_info['title']} - South America", 
                    fontsize=16, fontweight='bold', pad=20)
        ax.set_axis_off()
        
        # Add statistics text
        ax.text(0.02, 0.98, stats_text, transform=ax.transAxes, 
               fontsize=12, verticalalignment='top',
               bbox=dict(boxstyle='round', facecolor='white', alpha=0.8, pad=5))
        
        plt.tight_layout()
        out_file = OUTPUT_DIR / f"gsn_{layer_key}_individual.png"
        plt.savefig(out_file, dpi=300, bbox_inches='tight')
        print(f"   üíæ Saved: {out_file.name}")
        plt.close()


def create_combined_overview(all_data):
    """Create a combined overview showing all GSN layers."""
    if all_data is None or len(all_data) < 2:
        return
    
    print("üé® Creating combined GSN overview...")
    
    # Create a combined raster where each pixel value represents which layers overlap
    combined_data = np.zeros_like(list(all_data.values())[0]['data'], dtype=np.uint8)
    layer_count = np.zeros_like(combined_data, dtype=np.uint8)
    
    # Build combination logic
    for i, (layer_key, layer_info) in enumerate(GSN_LAYERS.items()):
        if layer_key not in all_data:
            continue
        data = all_data[layer_key]['data']
        # Add layer contribution (bitwise: 1, 2, 4, 8, 16)
        combined_data += data * (2 ** i)
        layer_count += data
    
    fig, ax = plt.subplots(figsize=(14, 12))
    
    # Create custom colormap for combinations
    colors = ['white']  # 0: no protection
    colors.extend([layer_info['color'] for layer_info in GSN_LAYERS.values()])
    
    # Add dark green variations for combinations
    combination_colors = ['#2E7D32', '#388E3C', '#43A047', '#4CAF50', '#66BB6A']  # Dark Green variations
    colors.extend(combination_colors[:3])  # Add a few combination colors
    
    cmap = ListedColormap(colors)
    
    # Normalize for display (simplified: show up to 3+ layers)
    display_data = np.minimum(layer_count, 3)
    
    im = ax.imshow(display_data, cmap=cmap, vmin=0, vmax=3, interpolation='nearest')
    
    ax.set_title("Global Safety Net - Combined Overview\nSouth America", 
                fontsize=18, fontweight='bold', pad=20)
    ax.set_axis_off()
    
    # Create legend
    legend_elements = []
    legend_elements.append(Patch(facecolor='white', label='No Protection'))
    
    for layer_key, layer_info in GSN_LAYERS.items():
        if layer_key in all_data:
            legend_elements.append(Patch(facecolor=layer_info['color'], 
                                       label=layer_info['title']))
    
    legend_elements.append(Patch(facecolor='#2E7D32', label='2+ Layers'))
    legend_elements.append(Patch(facecolor='#388E3C', label='3+ Layers'))
    
    ax.legend(handles=legend_elements, loc='upper right', bbox_to_anchor=(0.98, 0.98),
             fontsize=10, framealpha=0.9)
    
    # Add summary statistics
    total_protected = np.sum(layer_count > 0)
    total_pixels = layer_count.size
    protection_percentage = (total_protected / total_pixels) * 100
    
    stats_text = (f"Total protected pixels: {total_protected:,}\n"
                 f"Overall protection: {protection_percentage:.2f}%\n"
                 f"Layers active: {len(all_data)}")
    
    ax.text(0.02, 0.02, stats_text, transform=ax.transAxes, 
           fontsize=12, verticalalignment='bottom',
           bbox=dict(boxstyle='round', facecolor='white', alpha=0.8, pad=5))
    
    plt.tight_layout()
    out_file = OUTPUT_DIR / "gsn_combined_overview.png"
    plt.savefig(out_file, dpi=300, bbox_inches='tight')
    print(f"   üíæ Saved: {out_file.name}")
    plt.close()


def create_statistics_plot(all_data):
    """Create a bar chart showing protection statistics for each layer."""
    if all_data is None:
        return
    
    print("üìä Creating protection statistics plot...")
    
    layers = []
    percentages = []
    colors = []
    
    for layer_key, layer_info in GSN_LAYERS.items():
        if layer_key in all_data:
            layers.append(layer_info['title'])
            percentages.append(all_data[layer_key]['stats']['protected_percentage'])
            colors.append(layer_info['color'])
    
    fig, ax = plt.subplots(figsize=(12, 8))
    
    bars = ax.bar(layers, percentages, color=colors, alpha=0.9, edgecolor='black', linewidth=1.0)
    
    ax.set_title('Global Safety Net Protection Coverage by Layer\nSouth America', 
                fontsize=16, fontweight='bold', pad=20)
    ax.set_ylabel('Percentage of Area Protected (%)', fontsize=12)
    ax.set_xlabel('GSN Layer', fontsize=12)
    
    # Rotate x-axis labels for better readability
    plt.xticks(rotation=45, ha='right')
    
    # Add value labels on bars
    for bar, percentage in zip(bars, percentages):
        height = bar.get_height()
        ax.text(bar.get_x() + bar.get_width()/2., height + 0.1,
               f'{percentage:.2f}%', ha='center', va='bottom', fontweight='bold')
    
    ax.grid(axis='y', alpha=0.3)
    ax.set_ylim(0, max(percentages) * 1.1)
    
    plt.tight_layout()
    out_file = OUTPUT_DIR / "gsn_protection_statistics.png"
    plt.savefig(out_file, dpi=300, bbox_inches='tight')
    print(f"   üíæ Saved: {out_file.name}")
    plt.close()


def create_summary(all_data):
    """Print and save basic summary statistics."""
    if all_data is None:
        return
    
    print("\n" + "=" * 70)
    print("üìã GSN VISUALIZATION SUMMARY")
    print("=" * 70)
    print(f"Layers processed: {len(all_data)}")
    print(f"Output directory: {OUTPUT_DIR}")
    
    print("\nProtection Coverage by Layer:")
    for layer_key, layer_info in GSN_LAYERS.items():
        if layer_key in all_data:
            stats = all_data[layer_key]['stats']
            print(f"  ‚Ä¢ {layer_info['title']}: {stats['protected_percentage']:.2f}% "
                  f"({stats['protected_pixels']:,} pixels)")
    
    # Calculate total unique protection
    if len(all_data) > 1:
        layer_count = np.zeros_like(list(all_data.values())[0]['data'], dtype=np.uint8)
        for data_info in all_data.values():
            layer_count += data_info['data']
        
        total_protected = np.sum(layer_count > 0)
        total_pixels = layer_count.size
        overall_protection = (total_protected / total_pixels) * 100
        print(f"\nOverall protection (any layer): {overall_protection:.2f}% ({total_protected:,} pixels)")


def main():
    print("üåç Global Safety Net Visualization ‚Äî South America")
    print("=" * 70)
    
    all_data = load_gsn_data()
    if all_data is None:
        print("‚ùå Failed to load data. Exiting.")
        return
    
    print("\nüé® Creating visualizations...")
    create_individual_maps(all_data)
    create_combined_overview(all_data)
    create_statistics_plot(all_data)
    create_summary(all_data)
    
    print("\n‚úÖ Visualization complete! üéâ")


if __name__ == "__main__":
    main()
