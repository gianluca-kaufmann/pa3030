#!/usr/bin/env python3
"""
Hansen Global Forest Change Visualization for South America 2000-2024

This script creates visualizations of the Hansen Global Forest Change dataset
from multiple years (2000-2024) which contain 3 bands per year:
- forest_cover: Remaining forest cover (%)
- forest_loss: Forest lost in that specific year (binary)
- cumulative_loss: Total forest lost since 2000 (binary)
"""

import numpy as np
import rasterio
import matplotlib.pyplot as plt
from pathlib import Path
import warnings
from matplotlib.colors import ListedColormap, LinearSegmentedColormap

warnings.filterwarnings('ignore')

# Set up paths
data_dir = Path("/Users/gianluca/Desktop/Master's Thesis/code/data")
defor_dir = data_dir / "deforestation"
output_dir = Path("/Users/gianluca/Desktop/Master's Thesis/code/outputs/Figures/deforestation_vis")
output_dir.mkdir(parents=True, exist_ok=True)

# Years to process
YEARS = list(range(2000, 2025))  # 2000 to 2024 inclusive

# Color schemes
FOREST_CMAP = LinearSegmentedColormap.from_list('forest', 
    ['#f7f7f7', '#d1e5f0', '#92c5de', '#4393c3', '#2166ac', '#053061'][::-1])
LOSS_CMAP = LinearSegmentedColormap.from_list('loss', 
    ['#ffffff', '#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15'])

def load_deforestation_data():
    """Load the deforestation data for all years"""
    print("ðŸ“ Loading deforestation data for all years...")
    
    all_data = {}
    
    for year in YEARS:
        defor_file = defor_dir / f"Deforestation_SA_1km_{year}.tif"
        
        if not defor_file.exists():
            print(f"   âš ï¸ File not found: {defor_file.name}")
            continue
            
        try:
            with rasterio.open(defor_file) as src:
                data = src.read()
                
                print(f"   âœ… {year}: Shape: {data.shape}, Valid pixels: {np.sum(~np.isnan(data)):,}")
                
                # Expected band names
                band_names = [
                    f"forest_cover_{year}",
                    f"forest_loss_{year}",
                    f"cumulative_loss_{year}"
                ]
                
                all_data[year] = {
                    'data': data,
                    'src': src,
                    'band_names': band_names,
                    'file_path': defor_file,
                    'forest_cover': data[0] if data.shape[0] >= 1 else None,
                    'forest_loss': data[1] if data.shape[0] >= 2 else None,
                    'cumulative_loss': data[2] if data.shape[0] >= 3 else None
                }
                
        except Exception as e:
            print(f"   âŒ Error loading {year}: {e}")
            continue
    
    if not all_data:
        print("   âŒ No data loaded successfully")
        return None
    
    print(f"   ðŸ“Š Successfully loaded {len(all_data)} years")
    return all_data

def create_three_band_overview(all_data):
    """Create overview showing all three bands for each year"""
    if all_data is None:
        return
    
    print("ðŸŽ¨ Creating three-band overview for each year...")
    
    for year, data_info in all_data.items():
        forest_cover = data_info['forest_cover']
        forest_loss = data_info['forest_loss']
        cumulative_loss = data_info['cumulative_loss']
        
        # Create 1x3 grid for 3 bands
        fig, axes = plt.subplots(1, 3, figsize=(18, 6))
        fig.suptitle(f'Forest Change - South America {year}', 
                    fontsize=16, fontweight='bold')
        
        # Band 1: Forest Cover
        if forest_cover is not None:
            im1 = axes[0].imshow(forest_cover, cmap=FOREST_CMAP, aspect='auto', vmin=0, vmax=100)
            mean_cover = np.nanmean(forest_cover)
            axes[0].set_title(f'Forest Cover (%)\nMean: {mean_cover:.2f}%', 
                            fontsize=12, fontweight='bold')
            cbar1 = plt.colorbar(im1, ax=axes[0], shrink=0.8)
            cbar1.set_label('Cover (%)', rotation=270, labelpad=15)
        
        # Band 2: Forest Loss (this year)
        if forest_loss is not None:
            im2 = axes[1].imshow(forest_loss, cmap=LOSS_CMAP, aspect='auto', vmin=0, vmax=1)
            loss_pixels = np.nansum(forest_loss > 0)
            total_pixels = np.sum(~np.isnan(forest_loss))
            loss_pct = (loss_pixels / total_pixels * 100) if total_pixels > 0 else 0
            axes[1].set_title(f'Forest Loss in {year}\nLoss: {loss_pct:.3f}% of area', 
                            fontsize=12, fontweight='bold')
            cbar2 = plt.colorbar(im2, ax=axes[1], shrink=0.8)
            cbar2.set_label('Loss', rotation=270, labelpad=15)
        
        # Band 3: Cumulative Loss
        if cumulative_loss is not None:
            im3 = axes[2].imshow(cumulative_loss, cmap=LOSS_CMAP, aspect='auto', vmin=0, vmax=1)
            cum_loss_pixels = np.nansum(cumulative_loss > 0)
            total_pixels = np.sum(~np.isnan(cumulative_loss))
            cum_loss_pct = (cum_loss_pixels / total_pixels * 100) if total_pixels > 0 else 0
            axes[2].set_title(f'Cumulative Loss (2000-{year})\nTotal: {cum_loss_pct:.2f}% of area', 
                            fontsize=12, fontweight='bold')
            cbar3 = plt.colorbar(im3, ax=axes[2], shrink=0.8)
            cbar3.set_label('Loss', rotation=270, labelpad=15)
        
        # Remove axis labels for cleaner look
        for ax in axes:
            ax.set_xticks([])
            ax.set_yticks([])
        
        plt.tight_layout()
        
        # Save the plot
        output_file = output_dir / f"deforestation_sa_{year}_overview.png"
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"   ðŸ’¾ Saved: {output_file.name}")
        
        plt.close()  # Close to free memory

def create_forest_cover_timeline(all_data):
    """Create timeline showing forest cover evolution"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("ðŸ“ˆ Creating forest cover timeline...")
    
    years = sorted(all_data.keys())
    
    # Select key years to display (every 3 years + first and last)
    key_years = [years[0]] + years[2::3] + [years[-1]]
    key_years = sorted(list(set(key_years)))  # Remove duplicates and sort
    
    # Create figure with subplots for key years
    n_years = len(key_years)
    cols = min(4, n_years)
    rows = (n_years + cols - 1) // cols
    
    fig, axes = plt.subplots(rows, cols, figsize=(5*cols, 5*rows))
    fig.suptitle('Forest Cover Timeline - South America (2000-2024)', 
                fontsize=16, fontweight='bold')
    
    if n_years == 1:
        axes = [axes]
    else:
        axes = axes.flatten() if rows > 1 else axes
    
    for idx, year in enumerate(key_years):
        if year in all_data:
            ax = axes[idx]
            forest_cover = all_data[year]['forest_cover']
            
            if forest_cover is not None:
                im = ax.imshow(forest_cover, cmap=FOREST_CMAP, aspect='auto', vmin=0, vmax=100)
                mean_cover = np.nanmean(forest_cover)
                ax.set_title(f'{year}\nMean: {mean_cover:.2f}%', fontweight='bold')
                
                # Add colorbar
                cbar = plt.colorbar(im, ax=ax, shrink=0.8)
                cbar.set_label('%', rotation=0, labelpad=10)
                
                ax.set_xticks([])
                ax.set_yticks([])
    
    # Hide extra subplots
    for idx in range(len(key_years), len(axes)):
        axes[idx].axis('off')
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / "deforestation_forest_cover_timeline.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   ðŸ’¾ Saved: {output_file.name}")
    
    plt.close()

def create_temporal_statistics(all_data):
    """Create temporal statistics showing trends over time"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("ðŸ“Š Creating temporal statistics...")
    
    years = sorted(all_data.keys())
    
    # Collect statistics
    mean_cover = []
    annual_loss_pct = []
    cumulative_loss_pct = []
    
    for year in years:
        if year in all_data:
            # Forest cover
            forest_cover = all_data[year]['forest_cover']
            if forest_cover is not None:
                mean_cover.append(np.nanmean(forest_cover))
            else:
                mean_cover.append(np.nan)
            
            # Annual loss
            forest_loss = all_data[year]['forest_loss']
            if forest_loss is not None:
                loss_pixels = np.nansum(forest_loss > 0)
                total_pixels = np.sum(~np.isnan(forest_loss))
                loss_pct = (loss_pixels / total_pixels * 100) if total_pixels > 0 else 0
                annual_loss_pct.append(loss_pct)
            else:
                annual_loss_pct.append(np.nan)
            
            # Cumulative loss
            cumulative_loss = all_data[year]['cumulative_loss']
            if cumulative_loss is not None:
                cum_pixels = np.nansum(cumulative_loss > 0)
                total_pixels = np.sum(~np.isnan(cumulative_loss))
                cum_pct = (cum_pixels / total_pixels * 100) if total_pixels > 0 else 0
                cumulative_loss_pct.append(cum_pct)
            else:
                cumulative_loss_pct.append(np.nan)
    
    # Create figure with subplots
    fig, axes = plt.subplots(3, 1, figsize=(14, 12))
    fig.suptitle('Deforestation Temporal Trends - South America (2000-2024)', 
                fontsize=16, fontweight='bold')
    
    # Plot 1: Mean forest cover over time
    ax1 = axes[0]
    ax1.plot(years, mean_cover, marker='o', linewidth=2, markersize=6, 
             color='#2166ac', label='Mean Forest Cover')
    ax1.fill_between(years, mean_cover, alpha=0.3, color='#2166ac')
    ax1.set_title('Mean Forest Cover Over Time', fontweight='bold', fontsize=12)
    ax1.set_xlabel('Year')
    ax1.set_ylabel('Mean Cover (%)')
    ax1.grid(True, alpha=0.3)
    ax1.legend()
    
    # Plot 2: Annual forest loss
    ax2 = axes[1]
    ax2.bar(years, annual_loss_pct, color='#de2d26', alpha=0.7, label='Annual Forest Loss')
    ax2.set_title('Annual Forest Loss (% of total area)', fontweight='bold', fontsize=12)
    ax2.set_xlabel('Year')
    ax2.set_ylabel('Annual Loss (%)')
    ax2.grid(True, alpha=0.3, axis='y')
    ax2.legend()
    
    # Plot 3: Cumulative loss
    ax3 = axes[2]
    ax3.plot(years, cumulative_loss_pct, marker='o', linewidth=2, markersize=6, 
             color='#a50f15', label='Cumulative Forest Loss')
    ax3.fill_between(years, cumulative_loss_pct, alpha=0.3, color='#a50f15')
    ax3.set_title('Cumulative Forest Loss Over Time (since 2000)', fontweight='bold', fontsize=12)
    ax3.set_xlabel('Year')
    ax3.set_ylabel('Cumulative Loss (%)')
    ax3.grid(True, alpha=0.3)
    ax3.legend()
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / "deforestation_temporal_trends.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   ðŸ’¾ Saved: {output_file.name}")
    
    plt.close()

def create_change_comparison(all_data):
    """Compare early vs late period"""
    if all_data is None or len(all_data) < 10:
        return
    
    print("ðŸ” Creating early vs late period comparison...")
    
    # Define periods
    early_years = [2000, 2001, 2002, 2003, 2004]
    late_years = [2020, 2021, 2022, 2023, 2024]
    
    # Calculate average forest cover for each period
    early_covers = []
    late_covers = []
    
    for year in early_years:
        if year in all_data and all_data[year]['forest_cover'] is not None:
            early_covers.append(all_data[year]['forest_cover'])
    
    for year in late_years:
        if year in all_data and all_data[year]['forest_cover'] is not None:
            late_covers.append(all_data[year]['forest_cover'])
    
    if not early_covers or not late_covers:
        print("   âš ï¸ Insufficient data for comparison")
        return
    
    early_avg = np.nanmean(np.stack(early_covers), axis=0)
    late_avg = np.nanmean(np.stack(late_covers), axis=0)
    change = late_avg - early_avg
    
    # Create figure
    fig, axes = plt.subplots(1, 3, figsize=(18, 6))
    fig.suptitle('Forest Cover Change: Early Period (2000-2004) vs Late Period (2020-2024)', 
                fontsize=14, fontweight='bold')
    
    # Early period
    im1 = axes[0].imshow(early_avg, cmap=FOREST_CMAP, aspect='auto', vmin=0, vmax=100)
    axes[0].set_title(f'Early Period (2000-2004)\nMean: {np.nanmean(early_avg):.2f}%', 
                     fontweight='bold')
    plt.colorbar(im1, ax=axes[0], shrink=0.8, label='Cover (%)')
    
    # Late period
    im2 = axes[1].imshow(late_avg, cmap=FOREST_CMAP, aspect='auto', vmin=0, vmax=100)
    axes[1].set_title(f'Late Period (2020-2024)\nMean: {np.nanmean(late_avg):.2f}%', 
                     fontweight='bold')
    plt.colorbar(im2, ax=axes[1], shrink=0.8, label='Cover (%)')
    
    # Change
    im3 = axes[2].imshow(change, cmap='RdYlGn', aspect='auto', 
                        vmin=-50, vmax=50)
    axes[2].set_title(f'Change (Late - Early)\nMean: {np.nanmean(change):.2f}%', 
                     fontweight='bold')
    plt.colorbar(im3, ax=axes[2], shrink=0.8, label='Change (%)')
    
    for ax in axes:
        ax.set_xticks([])
        ax.set_yticks([])
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / "deforestation_period_comparison.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   ðŸ’¾ Saved: {output_file.name}")
    
    plt.close()

def main():
    """Main visualization function"""
    print("ðŸŒ² Hansen Global Forest Change Visualization - South America 2000-2024")
    print("=" * 70)
    
    # Load data
    all_data = load_deforestation_data()
    
    if all_data is None:
        print("âŒ Failed to load data. Exiting.")
        return
    
    # Create visualizations
    print("\nðŸŽ¨ Creating visualizations...")
    
    # 1. Three-band overview for each year
    create_three_band_overview(all_data)
    
    # 2. Forest cover timeline
    create_forest_cover_timeline(all_data)
    
    # 3. Temporal statistics
    create_temporal_statistics(all_data)
    
    # 4. Period comparison
    create_change_comparison(all_data)
    
    # Summary
    print("\n" + "=" * 70)
    print("ðŸ“‹ VISUALIZATION SUMMARY")
    print("=" * 70)
    
    print(f"Years processed: {sorted(all_data.keys())}")
    print(f"Total years: {len(all_data)}")
    
    # Show data info for first year as example
    first_year = min(all_data.keys())
    data = all_data[first_year]['data']
    print(f"Data shape per year: {data.shape}")
    print(f"Number of bands: {data.shape[0]}")
    print(f"Spatial dimensions: {data.shape[1]} x {data.shape[2]}")
    print(f"Total pixels per year: {data.shape[1] * data.shape[2]:,}")
    
    print(f"\nBands per year:")
    print(f"  - forest_cover_YYYY: Remaining forest cover (%)")
    print(f"  - forest_loss_YYYY: Forest lost in that specific year (binary)")
    print(f"  - cumulative_loss_YYYY: Total forest lost since 2000 (binary)")
    
    print(f"\nðŸ’¾ Output files saved to: {output_dir}")
    print(f"   - {len(all_data)} individual year overviews (deforestation_sa_YYYY_overview.png)")
    print("   - deforestation_forest_cover_timeline.png")
    print("   - deforestation_temporal_trends.png")
    print("   - deforestation_period_comparison.png")
    
    print("\nâœ… Visualization complete! ðŸŽ‰")

if __name__ == "__main__":
    main()

