#!/usr/bin/env python3
"""
MODIS NDVI visualization for South America (2000-2024).

Inputs:
- GeoTIFF rasters stored in `data/ready/NDVI`, named `NDVI_SA_1km_<year>.tif` for years 2000-2024.

Process:
- Loads each raster, scales MODIS NDVI values, computes summary statistics, and produces annual, temporal, and comparative visualisations.

Outputs:
- PNG figures written to `outputs/Figures/NDVI_vis`.
"""

import numpy as np
import rasterio
import matplotlib.pyplot as plt
from pathlib import Path
import warnings
from matplotlib.colors import LinearSegmentedColormap

warnings.filterwarnings('ignore')

# Set up paths
ROOT_DIR = Path(__file__).resolve().parents[2]
DATA_DIR = ROOT_DIR / "data"
NDVI_DIR = DATA_DIR / "ready" / "NDVI"
OUTPUT_DIR = ROOT_DIR / "outputs" / "Figures" / "NDVI_vis"
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

# Years to process
YEARS = list(range(2000, 2025))  # 2000 to 2024 inclusive

# NDVI colormap (brown to green)
def create_ndvi_colormap():
    """Create a brown-to-green colormap typical for NDVI"""
    colors = ['#8B4513', '#D2B48C', '#F5DEB3', '#FFFFE0', '#90EE90', '#228B22', '#006400']
    n_bins = 256
    return LinearSegmentedColormap.from_list('ndvi', colors, N=n_bins)

NDVI_CMAP = create_ndvi_colormap()

def load_ndvi_data():
    """Load the NDVI data for all years"""
    print("Loading NDVI data for all years...")
    
    all_data = {}
    
    for year in YEARS:
        ndvi_file = NDVI_DIR / f"NDVI_SA_1km_{year}.tif"
        
        if not ndvi_file.exists():
            print(f"   Warning: file not found: {ndvi_file.name}")
            continue
            
        try:
            with rasterio.open(ndvi_file) as src:
                # Read the data - MODIS NDVI is stored as integers with scale factor
                data = src.read(1)  # Single band
                
                # MODIS NDVI scale: values are typically -2000 to 10000, scale by 0.0001
                # Convert to standard NDVI range (-1 to 1)
                data = data.astype(np.float32) * 0.0001
                
                # Mask invalid values
                data = np.where((data < -1) | (data > 1), np.nan, data)
                
                print(f"   {year}: shape: {data.shape}, valid pixels: {np.sum(~np.isnan(data)):,}, "
                      f"NDVI range: [{np.nanmin(data):.3f}, {np.nanmax(data):.3f}]")
                
                all_data[year] = {
                    'data': data,
                    'src': src,
                    'file_path': ndvi_file
                }
                
        except Exception as e:
            print(f"   Error loading {year}: {e}")
            continue
    
    if not all_data:
        print("   No data loaded successfully")
        return None
    
    print(f"   Successfully loaded {len(all_data)} years")
    return all_data

def create_simple_overview(all_data):
    """Create simple overview for each year"""
    if all_data is None:
        return
    
    print("Creating simple overview for each year...")
    
    for year, data_info in all_data.items():
        data = data_info['data']
        
        # Create figure
        fig, axes = plt.subplots(1, 2, figsize=(16, 6))
        fig.suptitle(f'MODIS NDVI - South America {year}', 
                    fontsize=16, fontweight='bold')
        
        # Left: NDVI map
        ax1 = axes[0]
        im1 = ax1.imshow(data, cmap=NDVI_CMAP, aspect='auto', vmin=-0.2, vmax=1.0)
        ax1.set_title('NDVI Map', fontsize=12, fontweight='bold')
        ax1.set_xticks([])
        ax1.set_yticks([])
        cbar1 = plt.colorbar(im1, ax=ax1, shrink=0.8)
        cbar1.set_label('NDVI', rotation=270, labelpad=15)
        
        # Right: NDVI histogram
        ax2 = axes[1]
        valid_data = data[~np.isnan(data)]
        ax2.hist(valid_data, bins=100, color='green', alpha=0.7, edgecolor='black')
        ax2.set_title('NDVI Distribution', fontsize=12, fontweight='bold')
        ax2.set_xlabel('NDVI')
        ax2.set_ylabel('Frequency')
        ax2.grid(True, alpha=0.3)
        
        # Add statistics text
        mean_ndvi = np.nanmean(data)
        median_ndvi = np.nanmedian(data)
        std_ndvi = np.nanstd(data)
        stats_text = f'Mean: {mean_ndvi:.3f}\nMedian: {median_ndvi:.3f}\nStd: {std_ndvi:.3f}'
        ax2.text(0.02, 0.98, stats_text, transform=ax2.transAxes,
                fontsize=10, verticalalignment='top',
                bbox=dict(boxstyle='round', facecolor='wheat', alpha=0.5))
        
        plt.tight_layout()
        
        # Save the plot
        output_file = OUTPUT_DIR / f"ndvi_sa_{year}_overview.png"
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"   Saved: {output_file.name}")
        
        plt.close()  # Close to free memory

def create_temporal_comparison(all_data):
    """Create temporal comparison of NDVI changes"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("Creating temporal comparison...")
    
    # Calculate statistics for each year
    years = sorted(all_data.keys())
    mean_ndvi = []
    median_ndvi = []
    std_ndvi = []
    
    for year in years:
        data = all_data[year]['data']
        mean_ndvi.append(np.nanmean(data))
        median_ndvi.append(np.nanmedian(data))
        std_ndvi.append(np.nanstd(data))
    
    # Create figure with two subplots
    fig, axes = plt.subplots(2, 1, figsize=(14, 10))
    fig.suptitle('Temporal Evolution of NDVI (2000-2024)', 
                fontsize=16, fontweight='bold')
    
    # Top: Mean NDVI over time
    ax1 = axes[0]
    ax1.plot(years, mean_ndvi, marker='o', linewidth=2, markersize=6,
            color='darkgreen', label='Mean NDVI')
    ax1.fill_between(years, 
                      np.array(mean_ndvi) - np.array(std_ndvi),
                      np.array(mean_ndvi) + np.array(std_ndvi),
                      alpha=0.2, color='green', label='±1 Std Dev')
    ax1.set_title('Mean NDVI Over Time', fontweight='bold')
    ax1.set_xlabel('Year')
    ax1.set_ylabel('Mean NDVI')
    ax1.grid(True, alpha=0.3)
    ax1.legend()
    ax1.set_xlim(years[0]-1, years[-1]+1)
    
    # Bottom: Median NDVI and standard deviation
    ax2 = axes[1]
    ax2_twin = ax2.twinx()
    
    line1 = ax2.plot(years, median_ndvi, marker='s', linewidth=2, markersize=6,
                     color='forestgreen', label='Median NDVI')
    line2 = ax2_twin.plot(years, std_ndvi, marker='^', linewidth=2, markersize=6,
                          color='orange', label='Std Dev', alpha=0.7)
    
    ax2.set_title('Median NDVI and Variability Over Time', fontweight='bold')
    ax2.set_xlabel('Year')
    ax2.set_ylabel('Median NDVI', color='forestgreen')
    ax2_twin.set_ylabel('Standard Deviation', color='orange')
    ax2.tick_params(axis='y', labelcolor='forestgreen')
    ax2_twin.tick_params(axis='y', labelcolor='orange')
    ax2.grid(True, alpha=0.3)
    ax2.set_xlim(years[0]-1, years[-1]+1)
    
    # Combine legends
    lines = line1 + line2
    labels = [l.get_label() for l in lines]
    ax2.legend(lines, labels, loc='upper left')
    
    plt.tight_layout()
    
    # Save the plot
    output_file = OUTPUT_DIR / "ndvi_temporal_comparison.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   Saved: {output_file.name}")
    
    plt.close()

def create_multi_year_comparison(all_data):
    """Create a grid comparison of multiple years"""
    if all_data is None or len(all_data) < 4:
        return
    
    print("Creating multi-year comparison grid...")
    
    # Select a subset of years to display (every 5 years + last year)
    years = sorted(all_data.keys())
    selected_years = [y for y in years if (y - 2000) % 5 == 0 or y == years[-1]]
    
    n_years = len(selected_years)
    n_cols = 3
    n_rows = (n_years + n_cols - 1) // n_cols
    
    fig, axes = plt.subplots(n_rows, n_cols, figsize=(15, 5*n_rows))
    fig.suptitle('NDVI Multi-Year Comparison (Selected Years)', 
                fontsize=16, fontweight='bold')
    
    axes_flat = axes.flatten() if n_rows > 1 else [axes] if n_years == 1 else axes
    
    for idx, year in enumerate(selected_years):
        ax = axes_flat[idx]
        data = all_data[year]['data']
        
        im = ax.imshow(data, cmap=NDVI_CMAP, aspect='auto', vmin=-0.2, vmax=1.0)
        
        mean_val = np.nanmean(data)
        ax.set_title(f'{year}\nMean NDVI: {mean_val:.3f}', 
                    fontsize=10, fontweight='bold')
        ax.set_xticks([])
        ax.set_yticks([])
        
        # Add colorbar
        cbar = plt.colorbar(im, ax=ax, shrink=0.8)
        cbar.set_label('NDVI', rotation=270, labelpad=10)
    
    # Hide extra subplots
    for idx in range(len(selected_years), len(axes_flat)):
        axes_flat[idx].axis('off')
    
    plt.tight_layout()
    
    # Save the plot
    output_file = OUTPUT_DIR / "ndvi_multi_year_comparison.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   Saved: {output_file.name}")
    
    plt.close()

def create_change_analysis(all_data):
    """Create change analysis between first and last year"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("Creating change analysis...")
    
    years = sorted(all_data.keys())
    first_year = years[0]
    last_year = years[-1]
    
    data_first = all_data[first_year]['data']
    data_last = all_data[last_year]['data']
    
    # Calculate change
    change = data_last - data_first
    
    # Create figure
    fig, axes = plt.subplots(1, 3, figsize=(18, 5))
    fig.suptitle(f'NDVI Change Analysis ({first_year} → {last_year})', 
                fontsize=16, fontweight='bold')
    
    # First year
    ax1 = axes[0]
    im1 = ax1.imshow(data_first, cmap=NDVI_CMAP, aspect='auto', vmin=-0.2, vmax=1.0)
    ax1.set_title(f'{first_year}\nMean: {np.nanmean(data_first):.3f}', fontweight='bold')
    ax1.set_xticks([])
    ax1.set_yticks([])
    cbar1 = plt.colorbar(im1, ax=ax1, shrink=0.8)
    cbar1.set_label('NDVI', rotation=270, labelpad=15)
    
    # Last year
    ax2 = axes[1]
    im2 = ax2.imshow(data_last, cmap=NDVI_CMAP, aspect='auto', vmin=-0.2, vmax=1.0)
    ax2.set_title(f'{last_year}\nMean: {np.nanmean(data_last):.3f}', fontweight='bold')
    ax2.set_xticks([])
    ax2.set_yticks([])
    cbar2 = plt.colorbar(im2, ax=ax2, shrink=0.8)
    cbar2.set_label('NDVI', rotation=270, labelpad=15)
    
    # Change
    ax3 = axes[2]
    im3 = ax3.imshow(change, cmap='RdYlGn', aspect='auto', vmin=-0.5, vmax=0.5)
    ax3.set_title(f'Change ({last_year}-{first_year})\nMean: {np.nanmean(change):.3f}', 
                 fontweight='bold')
    ax3.set_xticks([])
    ax3.set_yticks([])
    cbar3 = plt.colorbar(im3, ax=ax3, shrink=0.8)
    cbar3.set_label('NDVI Change', rotation=270, labelpad=15)
    
    plt.tight_layout()
    
    # Save the plot
    output_file = OUTPUT_DIR / f"ndvi_change_analysis_{first_year}_{last_year}.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   Saved: {output_file.name}")
    
    plt.close()

def create_summary_statistics(all_data):
    """Create summary statistics visualization"""
    if all_data is None:
        return
    
    print("Creating summary statistics...")
    
    years = sorted(all_data.keys())
    
    # Collect statistics
    stats = {
        'mean': [],
        'median': [],
        'std': [],
        'min': [],
        'max': [],
        'q25': [],
        'q75': []
    }
    
    for year in years:
        data = all_data[year]['data']
        valid_data = data[~np.isnan(data)]
        
        stats['mean'].append(np.mean(valid_data))
        stats['median'].append(np.median(valid_data))
        stats['std'].append(np.std(valid_data))
        stats['min'].append(np.min(valid_data))
        stats['max'].append(np.max(valid_data))
        stats['q25'].append(np.percentile(valid_data, 25))
        stats['q75'].append(np.percentile(valid_data, 75))
    
    # Create figure
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle('NDVI Summary Statistics (2000-2024)', 
                fontsize=16, fontweight='bold')
    
    # Plot 1: Mean and Median
    ax1 = axes[0, 0]
    ax1.plot(years, stats['mean'], marker='o', label='Mean', linewidth=2)
    ax1.plot(years, stats['median'], marker='s', label='Median', linewidth=2)
    ax1.fill_between(years, stats['q25'], stats['q75'], alpha=0.2, label='IQR (25-75%)')
    ax1.set_title('Central Tendency', fontweight='bold')
    ax1.set_xlabel('Year')
    ax1.set_ylabel('NDVI')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # Plot 2: Variability (Standard Deviation)
    ax2 = axes[0, 1]
    ax2.plot(years, stats['std'], marker='o', color='orange', linewidth=2)
    ax2.set_title('Variability (Standard Deviation)', fontweight='bold')
    ax2.set_xlabel('Year')
    ax2.set_ylabel('Standard Deviation')
    ax2.grid(True, alpha=0.3)
    
    # Plot 3: Range (Min and Max)
    ax3 = axes[1, 0]
    ax3.plot(years, stats['max'], marker='^', label='Max', linewidth=2, color='darkgreen')
    ax3.plot(years, stats['min'], marker='v', label='Min', linewidth=2, color='brown')
    ax3.fill_between(years, stats['min'], stats['max'], alpha=0.1)
    ax3.set_title('Range (Min-Max)', fontweight='bold')
    ax3.set_xlabel('Year')
    ax3.set_ylabel('NDVI')
    ax3.legend()
    ax3.grid(True, alpha=0.3)
    
    # Plot 4: Box plot for selected years
    ax4 = axes[1, 1]
    selected_years = [y for y in years if (y - 2000) % 5 == 0 or y == years[-1]]
    box_data = [all_data[year]['data'][~np.isnan(all_data[year]['data'])] for year in selected_years]
    bp = ax4.boxplot(box_data, labels=selected_years, patch_artist=True)
    for patch in bp['boxes']:
        patch.set_facecolor('lightgreen')
    ax4.set_title('Distribution (Selected Years)', fontweight='bold')
    ax4.set_xlabel('Year')
    ax4.set_ylabel('NDVI')
    ax4.grid(True, alpha=0.3, axis='y')
    plt.setp(ax4.xaxis.get_majorticklabels(), rotation=45)
    
    plt.tight_layout()
    
    # Save the plot
    output_file = OUTPUT_DIR / "ndvi_summary_statistics.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   Saved: {output_file.name}")
    
    plt.close()

def main():
    """Main visualization function"""
    print("MODIS NDVI Visualization - South America 2000-2024")
    print("=" * 70)
    
    # Load data
    all_data = load_ndvi_data()
    
    if all_data is None:
        print("Failed to load data. Exiting.")
        return
    
    # Create visualizations
    print("\nCreating visualizations...")
    
    # 1. Simple overview for each year
    create_simple_overview(all_data)
    
    # 2. Temporal comparison
    create_temporal_comparison(all_data)
    
    # 3. Multi-year comparison
    create_multi_year_comparison(all_data)
    
    # 4. Change analysis
    create_change_analysis(all_data)
    
    # 5. Summary statistics
    create_summary_statistics(all_data)
    
    # Summary
    print("\n" + "=" * 70)
    print("VISUALIZATION SUMMARY")
    print("=" * 70)
    
    print(f"Years processed: {sorted(all_data.keys())}")
    print(f"Total years: {len(all_data)}")
    
    # Show data info for first year as example
    first_year = min(all_data.keys())
    data = all_data[first_year]['data']
    print(f"Data shape per year: {data.shape}")
    print(f"Spatial dimensions: {data.shape[0]} x {data.shape[1]}")
    print(f"Total pixels per year: {data.shape[0] * data.shape[1]:,}")
    
    # Calculate overall statistics
    all_means = [np.nanmean(all_data[year]['data']) for year in sorted(all_data.keys())]
    print(f"\nOverall NDVI statistics:")
    print(f"  - Mean across all years: {np.mean(all_means):.3f}")
    print(f"  - Min mean: {np.min(all_means):.3f}")
    print(f"  - Max mean: {np.max(all_means):.3f}")
    
    print(f"\nOutput files saved to: {OUTPUT_DIR}")
    print(f"   - {len(all_data)} individual year overview files")
    print("   - ndvi_temporal_comparison.png")
    print("   - ndvi_multi_year_comparison.png")
    print(f"   - ndvi_change_analysis_{min(all_data.keys())}_{max(all_data.keys())}.png")
    print("   - ndvi_summary_statistics.png")

    print("\nVisualization complete.")

if __name__ == "__main__":
    main()

