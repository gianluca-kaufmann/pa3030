#!/usr/bin/env python3
"""
VIIRS Nighttime Lights Visualization for South America 2013-2022

This script creates visualizations of the VIIRS nighttime lights data
from multiple years (2013-2022) which contain average radiance values
at 1km resolution.
"""

import numpy as np
import rasterio
import matplotlib.pyplot as plt
from pathlib import Path
import warnings
from matplotlib.colors import LinearSegmentedColormap

warnings.filterwarnings('ignore')

# Set up paths
data_dir = Path("/Users/gianluca/Desktop/Master's Thesis/code/data")
viirs_dir = data_dir / "VIIRS"
output_dir = Path("/Users/gianluca/Desktop/Master's Thesis/code/outputs/Figures/VIIRS_vis")
output_dir.mkdir(parents=True, exist_ok=True)

# Years to process
YEARS = [2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022]

# VIIRS visualization settings
VIIRS_COLORMAP = 'plasma'  # Good for nighttime lights
VIIRS_COLOR = '#FFD700'  # Gold color for nighttime lights

def load_viirs_data():
    """Load the VIIRS nighttime lights data for all years"""
    print("üìÅ Loading VIIRS nighttime lights data for all years...")
    
    all_data = {}
    
    for year in YEARS:
        viirs_file = viirs_dir / f"VIIRS_SA_1km_{year}.tif"
        
        if not viirs_file.exists():
            print(f"   ‚ö†Ô∏è File not found: {viirs_file.name}")
            continue
            
        try:
            with rasterio.open(viirs_file) as src:
                data = src.read()
                
                print(f"   ‚úÖ {year}: Shape: {data.shape}, Valid pixels: {np.sum(~np.isnan(data)):,}")
                
                all_data[year] = {
                    'data': data,
                    'src': src,
                    'file_path': viirs_file
                }
                
        except Exception as e:
            print(f"   ‚ùå Error loading {year}: {e}")
            continue
    
    if not all_data:
        print("   ‚ùå No data loaded successfully")
        return None
    
    print(f"   üìä Successfully loaded {len(all_data)} years")
    return all_data

def create_simple_overview(all_data):
    """Create simple overview for each year"""
    if all_data is None:
        return
    
    print("üé® Creating simple overview for each year...")
    
    # First, calculate global statistics across all years to set consistent color limits
    all_values = []
    for data_info in all_data.values():
        band_data = data_info['data'][0]
        valid_data = band_data[~np.isnan(band_data)]
        all_values.extend(valid_data)
    
    all_values = np.array(all_values)
    global_percentile_95 = np.percentile(all_values, 95)
    global_percentile_99 = np.percentile(all_values, 99)
    
    print(f"   üìä Global statistics: 95th percentile: {global_percentile_95:.3f}, 99th percentile: {global_percentile_99:.3f}")
    
    for year, data_info in all_data.items():
        data = data_info['data']
        
        # VIIRS data has only one band (average radiance)
        band_data = data[0]  # First (and only) band
        
        # Create figure
        fig, ax = plt.subplots(figsize=(12, 10))
        
        # Calculate year-specific statistics
        mean_val = np.nanmean(band_data)
        max_val = np.nanmax(band_data)
        std_val = np.nanstd(band_data)
        percentile_95 = np.percentile(band_data[~np.isnan(band_data)], 95)
        percentile_99 = np.percentile(band_data[~np.isnan(band_data)], 99)
        
        # Use 95th percentile as vmax to better show variation
        vmax = percentile_95
        
        # Create visualization with appropriate colormap and limits
        im = ax.imshow(band_data, cmap=VIIRS_COLORMAP, aspect='auto', vmin=0, vmax=vmax)
        
        ax.set_title(f'VIIRS Nighttime Lights - South America {year}\n'
                    f'Mean: {mean_val:.3f}, Max: {max_val:.3f}, 95th%: {percentile_95:.3f}', 
                    fontsize=14, fontweight='bold')
        
        # Add colorbar
        cbar = plt.colorbar(im, ax=ax, shrink=0.8)
        cbar.set_label('Average Radiance (nW/cm¬≤/sr)', rotation=270, labelpad=20)
        
        # Remove axis labels for cleaner look
        ax.set_xticks([])
        ax.set_yticks([])
        
        plt.tight_layout()
        
        # Save the plot
        output_file = output_dir / f"viirs_nighttime_lights_sa_{year}_overview.png"
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"   üíæ Saved: {output_file.name}")
        
        plt.close()  # Close to free memory

def create_temporal_comparison(all_data):
    """Create temporal comparison of nighttime lights changes"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("üìà Creating temporal comparison...")
    
    # Calculate statistics for each year
    temporal_data = {}
    
    for year, data_info in all_data.items():
        data = data_info['data']
        band_data = data[0]  # First (and only) band
        
        temporal_data[year] = {
            'mean': np.nanmean(band_data),
            'max': np.nanmax(band_data),
            'std': np.nanstd(band_data),
            'total': np.nansum(band_data)
        }
    
    # Create figure with subplots
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle('Temporal Comparison of VIIRS Nighttime Lights (2013-2022)', 
                fontsize=16, fontweight='bold')
    
    years = sorted(temporal_data.keys())
    
    # 1. Mean radiance over time
    ax1 = axes[0, 0]
    means = [temporal_data[year]['mean'] for year in years]
    ax1.plot(years, means, marker='o', linewidth=2, markersize=8,
             color=VIIRS_COLOR, label='Mean Radiance')
    ax1.set_title('Mean Radiance Over Time', fontweight='bold')
    ax1.set_xlabel('Year')
    ax1.set_ylabel('Mean Radiance (nW/cm¬≤/sr)')
    ax1.grid(True, alpha=0.3)
    ax1.set_xticks(years)
    
    # Add value labels on points
    for year, value in zip(years, means):
        ax1.annotate(f'{value:.3f}', (year, value), 
                   textcoords="offset points", xytext=(0,10), ha='center')
    
    # 2. Maximum radiance over time
    ax2 = axes[0, 1]
    maxs = [temporal_data[year]['max'] for year in years]
    ax2.plot(years, maxs, marker='s', linewidth=2, markersize=8,
             color='red', label='Max Radiance')
    ax2.set_title('Maximum Radiance Over Time', fontweight='bold')
    ax2.set_xlabel('Year')
    ax2.set_ylabel('Max Radiance (nW/cm¬≤/sr)')
    ax2.grid(True, alpha=0.3)
    ax2.set_xticks(years)
    
    # Add value labels on points
    for year, value in zip(years, maxs):
        ax2.annotate(f'{value:.1f}', (year, value), 
                   textcoords="offset points", xytext=(0,10), ha='center')
    
    # 3. Standard deviation over time
    ax3 = axes[1, 0]
    stds = [temporal_data[year]['std'] for year in years]
    ax3.plot(years, stds, marker='^', linewidth=2, markersize=8,
             color='green', label='Standard Deviation')
    ax3.set_title('Radiance Variability Over Time', fontweight='bold')
    ax3.set_xlabel('Year')
    ax3.set_ylabel('Standard Deviation (nW/cm¬≤/sr)')
    ax3.grid(True, alpha=0.3)
    ax3.set_xticks(years)
    
    # Add value labels on points
    for year, value in zip(years, stds):
        ax3.annotate(f'{value:.3f}', (year, value), 
                   textcoords="offset points", xytext=(0,10), ha='center')
    
    # 4. Total radiance over time
    ax4 = axes[1, 1]
    totals = [temporal_data[year]['total'] for year in years]
    ax4.plot(years, totals, marker='d', linewidth=2, markersize=8,
             color='purple', label='Total Radiance')
    ax4.set_title('Total Radiance Over Time', fontweight='bold')
    ax4.set_xlabel('Year')
    ax4.set_ylabel('Total Radiance (nW/cm¬≤/sr)')
    ax4.grid(True, alpha=0.3)
    ax4.set_xticks(years)
    
    # Add value labels on points
    for year, value in zip(years, totals):
        ax4.annotate(f'{value:.0f}', (year, value), 
                   textcoords="offset points", xytext=(0,10), ha='center')
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / "viirs_nighttime_lights_temporal_comparison.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   üíæ Saved: {output_file.name}")
    
    plt.show()

def create_summary_statistics(all_data):
    """Create summary statistics across all years"""
    if all_data is None:
        return
    
    print("üìä Creating summary statistics...")
    
    # Collect statistics for all years
    all_stats = []
    
    for year, data_info in all_data.items():
        data = data_info['data']
        band_data = data[0]  # First (and only) band
        
        stats = {
            'year': year,
            'mean': np.nanmean(band_data),
            'std': np.nanstd(band_data),
            'max': np.nanmax(band_data),
            'min': np.nanmin(band_data),
            'total': np.nansum(band_data),
            'valid_pixels': np.sum(~np.isnan(band_data))
        }
        all_stats.append(stats)
    
    # Create figure
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle('VIIRS Nighttime Lights Summary Statistics (2013-2022)', 
                fontweight='bold', fontsize=16)
    
    years = sorted([s['year'] for s in all_stats])
    
    # 1. Mean radiance bar chart
    ax1 = axes[0, 0]
    means = [s['mean'] for s in all_stats]
    bars1 = ax1.bar(years, means, color=VIIRS_COLOR, alpha=0.8)
    ax1.set_title('Mean Radiance by Year', fontweight='bold')
    ax1.set_xlabel('Year')
    ax1.set_ylabel('Mean Radiance (nW/cm¬≤/sr)')
    ax1.grid(True, alpha=0.3)
    
    # Add value labels on bars
    for bar, value in zip(bars1, means):
        height = bar.get_height()
        ax1.annotate(f'{value:.3f}', xy=(bar.get_x() + bar.get_width()/2, height),
                    xytext=(0, 3), textcoords="offset points", ha='center', va='bottom')
    
    # 2. Maximum radiance bar chart
    ax2 = axes[0, 1]
    maxs = [s['max'] for s in all_stats]
    bars2 = ax2.bar(years, maxs, color='red', alpha=0.8)
    ax2.set_title('Maximum Radiance by Year', fontweight='bold')
    ax2.set_xlabel('Year')
    ax2.set_ylabel('Max Radiance (nW/cm¬≤/sr)')
    ax2.grid(True, alpha=0.3)
    
    # Add value labels on bars
    for bar, value in zip(bars2, maxs):
        height = bar.get_height()
        ax2.annotate(f'{value:.1f}', xy=(bar.get_x() + bar.get_width()/2, height),
                    xytext=(0, 3), textcoords="offset points", ha='center', va='bottom')
    
    # 3. Total radiance bar chart
    ax3 = axes[1, 0]
    totals = [s['total'] for s in all_stats]
    bars3 = ax3.bar(years, totals, color='purple', alpha=0.8)
    ax3.set_title('Total Radiance by Year', fontweight='bold')
    ax3.set_xlabel('Year')
    ax3.set_ylabel('Total Radiance (nW/cm¬≤/sr)')
    ax3.grid(True, alpha=0.3)
    
    # Add value labels on bars
    for bar, value in zip(bars3, totals):
        height = bar.get_height()
        ax3.annotate(f'{value:.0f}', xy=(bar.get_x() + bar.get_width()/2, height),
                    xytext=(0, 3), textcoords="offset points", ha='center', va='bottom')
    
    # 4. Valid pixels count
    ax4 = axes[1, 1]
    valid_pixels = [s['valid_pixels'] for s in all_stats]
    bars4 = ax4.bar(years, valid_pixels, color='green', alpha=0.8)
    ax4.set_title('Valid Pixels by Year', fontweight='bold')
    ax4.set_xlabel('Year')
    ax4.set_ylabel('Number of Valid Pixels')
    ax4.grid(True, alpha=0.3)
    
    # Add value labels on bars
    for bar, value in zip(bars4, valid_pixels):
        height = bar.get_height()
        ax4.annotate(f'{value:,}', xy=(bar.get_x() + bar.get_width()/2, height),
                    xytext=(0, 3), textcoords="offset points", ha='center', va='bottom')
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / "viirs_nighttime_lights_summary_statistics.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   üíæ Saved: {output_file.name}")
    
    plt.show()

def create_change_detection(all_data):
    """Create change detection visualization between first and last year"""
    if all_data is None or len(all_data) < 2:
        return
    
    print("üîÑ Creating change detection visualization...")
    
    # Get first and last year data
    first_year = min(all_data.keys())
    last_year = max(all_data.keys())
    
    first_data = all_data[first_year]['data'][0]  # First band
    last_data = all_data[last_year]['data'][0]    # First band
    
    # Calculate change
    change_data = last_data - first_data
    
    # Calculate consistent color limits for the first two images
    all_radiance_values = []
    for data_info in all_data.values():
        band_data = data_info['data'][0]
        valid_data = band_data[~np.isnan(band_data)]
        all_radiance_values.extend(valid_data)
    
    all_radiance_values = np.array(all_radiance_values)
    radiance_vmax = np.percentile(all_radiance_values, 95)
    
    # Calculate change limits
    change_values = change_data[~np.isnan(change_data)]
    change_vmax = np.percentile(np.abs(change_values), 95)
    
    # Create figure
    fig, axes = plt.subplots(1, 3, figsize=(18, 6))
    fig.suptitle(f'VIIRS Nighttime Lights Change Detection ({first_year} ‚Üí {last_year})', 
                fontsize=16, fontweight='bold')
    
    # 1. First year
    im1 = axes[0].imshow(first_data, cmap=VIIRS_COLORMAP, aspect='auto', vmin=0, vmax=radiance_vmax)
    axes[0].set_title(f'{first_year} Nighttime Lights', fontweight='bold')
    axes[0].set_xticks([])
    axes[0].set_yticks([])
    cbar1 = plt.colorbar(im1, ax=axes[0], shrink=0.8)
    cbar1.set_label('Radiance (nW/cm¬≤/sr)', rotation=270, labelpad=20)
    
    # 2. Last year
    im2 = axes[1].imshow(last_data, cmap=VIIRS_COLORMAP, aspect='auto', vmin=0, vmax=radiance_vmax)
    axes[1].set_title(f'{last_year} Nighttime Lights', fontweight='bold')
    axes[1].set_xticks([])
    axes[1].set_yticks([])
    cbar2 = plt.colorbar(im2, ax=axes[1], shrink=0.8)
    cbar2.set_label('Radiance (nW/cm¬≤/sr)', rotation=270, labelpad=20)
    
    # 3. Change (difference)
    im3 = axes[2].imshow(change_data, cmap='RdBu_r', aspect='auto', vmin=-change_vmax, vmax=change_vmax)
    axes[2].set_title(f'Change ({last_year} - {first_year})', fontweight='bold')
    axes[2].set_xticks([])
    axes[2].set_yticks([])
    cbar3 = plt.colorbar(im3, ax=axes[2], shrink=0.8)
    cbar3.set_label('Change in Radiance (nW/cm¬≤/sr)', rotation=270, labelpad=20)
    
    plt.tight_layout()
    
    # Save the plot
    output_file = output_dir / f"viirs_nighttime_lights_change_detection_{first_year}_{last_year}.png"
    plt.savefig(output_file, dpi=300, bbox_inches='tight')
    print(f"   üíæ Saved: {output_file.name}")
    
    plt.show()

def main():
    """Main visualization function"""
    print("üåô VIIRS Nighttime Lights Visualization - South America 2013-2022")
    print("=" * 70)
    
    # Load data
    all_data = load_viirs_data()
    
    if all_data is None:
        print("‚ùå Failed to load data. Exiting.")
        return
    
    # Create visualizations
    print("\nüé® Creating visualizations...")
    
    # 1. Simple overview for each year
    create_simple_overview(all_data)
    
    # 2. Temporal comparison
    create_temporal_comparison(all_data)
    
    # 3. Summary statistics
    create_summary_statistics(all_data)
    
    # 4. Change detection
    create_change_detection(all_data)
    
    # Summary
    print("\n" + "=" * 70)
    print("üìã VISUALIZATION SUMMARY")
    print("=" * 70)
    
    print(f"Years processed: {sorted(all_data.keys())}")
    print(f"Total years: {len(all_data)}")
    
    # Show data info for first year as example
    first_year = min(all_data.keys())
    data = all_data[first_year]['data']
    print(f"Data shape per year: {data.shape}")
    print(f"Number of bands: {data.shape[0]}")
    print(f"Spatial dimensions: {data.shape[1]} x {data.shape[2]}")
    print(f"Total pixels per year: {data.shape[1] * data.shape[2]:,}")
    
    print(f"\nData type: VIIRS Nighttime Lights (Average Radiance)")
    print(f"Units: nW/cm¬≤/sr (nanowatts per square centimeter per steradian)")
    
    print(f"\nüíæ Output files saved to: {output_dir}")
    for year in sorted(all_data.keys()):
        print(f"   - viirs_nighttime_lights_sa_{year}_overview.png")
    print("   - viirs_nighttime_lights_temporal_comparison.png")
    print("   - viirs_nighttime_lights_summary_statistics.png")
    print(f"   - viirs_nighttime_lights_change_detection_{min(all_data.keys())}_{max(all_data.keys())}.png")
    
    print("\n‚úÖ Visualization complete! üéâ")

if __name__ == "__main__":
    main()
