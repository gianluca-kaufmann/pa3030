#!/usr/bin/env python3
"""
Asset-level data preprocessing
==============================

Description:
    Prepare asset-level facility information for spatial analysis by aligning
    the data with the 1 km reference grid used across the project.

Source data:
    Input file `data/ready/assetlevel/FA_sample_data.xlsx` located in the
    project `data/ready` directory.

Objective:
    Filter the asset records to active facilities, align them to the reference
    raster grid, and calculate the count of assets and their total capacity per
    grid cell.

Process overview:
    1. Load the asset-level Excel file and identify the relevant sheet.
    2. Filter the dataset to facilities marked as active.
    3. Load spatial metadata from the population density GeoTIFF template.
    4. Rasterize the latitude and longitude information onto the template grid.
    5. Aggregate counts and capacities for each grid cell.
    6. Export GeoTIFF rasters with asset counts and total capacity.

Outputs:
    - `data/assetlevel/FA_assets_count_SA_1km.tif` containing counts of active
      assets per pixel.
    - `data/assetlevel/FA_assets_capacity_SA_1km.tif` containing total active
      capacity per pixel.
"""

import pandas as pd
import numpy as np
import rasterio
from rasterio.transform import from_bounds
from rasterio.crs import CRS
from pathlib import Path
import warnings
warnings.filterwarnings('ignore')

# ==========
# Configuration
# ==========

PROJECT_ROOT = Path(__file__).resolve().parents[2]
DATA_DIR = PROJECT_ROOT / "data"
READY_DIR = DATA_DIR / "ready"

ASSETLEVEL_DIR = READY_DIR / "assetlevel"
INPUT_EXCEL = ASSETLEVEL_DIR / "FA_sample_data.xlsx"
TEMPLATE_TIFF = READY_DIR / "GPW" / "GPW_population_density_SA_1km_2020.tif"
OUTPUT_DIR = ASSETLEVEL_DIR
OUTPUT_COUNT = OUTPUT_DIR / "FA_assets_count_SA_1km.tif"
OUTPUT_CAPACITY = OUTPUT_DIR / "FA_assets_capacity_SA_1km.tif"

def load_excel_data():
    """Load and examine the Excel data structure"""
    print(f"Loading Excel data from {INPUT_EXCEL.name}...")
    
    try:
        # Read the Excel file
        # Try different sheet names that might contain asset data
        excel_file = pd.ExcelFile(INPUT_EXCEL)
        print(f"   Available sheets: {excel_file.sheet_names}")
        
        # Look for asset-level data sheet
        asset_sheet = None
        for sheet_name in excel_file.sheet_names:
            if 'asset' in sheet_name.lower() or 'level' in sheet_name.lower():
                asset_sheet = sheet_name
                break
        
        if asset_sheet is None:
            # If no obvious sheet name, try the first sheet
            asset_sheet = excel_file.sheet_names[0]
            print(f"   Using first sheet: {asset_sheet}")
        else:
            print(f"   Found asset sheet: {asset_sheet}")
        
        # Read the data
        df = pd.read_excel(INPUT_EXCEL, sheet_name=asset_sheet)
        
        print(f"   Shape: {df.shape}")
        print(f"   Columns: {list(df.columns)}")
        
        # Display first few rows to understand structure
        print(f"   First 5 rows:")
        print(df.head())
        
        # Check for required columns
        required_cols = ['Latitude', 'Longitude', 'Capacity', 'status']
        missing_cols = [col for col in required_cols if col not in df.columns]
        
        if missing_cols:
            print(f"   Missing required columns: {missing_cols}")
            print(f"   Available columns: {list(df.columns)}")
            
            # Try case-insensitive matching
            col_mapping = {}
            for req_col in required_cols:
                for avail_col in df.columns:
                    if req_col.lower() in avail_col.lower() or avail_col.lower() in req_col.lower():
                        col_mapping[req_col] = avail_col
                        break
            
            print(f"   Suggested column mapping: {col_mapping}")
            
            # Update column names if we found matches
            df = df.rename(columns={v: k for k, v in col_mapping.items()})
            print(f"   Updated columns: {list(df.columns)}")
        
        return df
        
    except Exception as e:
        print(f"   Error loading Excel file: {e}")
        return None

def filter_active_plants(df):
    """Filter to only active plants"""
    if df is None:
        return None
    
    print("Filtering to active plants...")
    
    # Check status column values
    if 'status' not in df.columns:
        print("   No 'status' column found")
        return None
    
    print(f"   Status values: {df['status'].value_counts()}")
    
    # Filter for active plants (common status values for active)
    active_statuses = ['active', 'operational', 'operating', 'running', 'online', 'commissioned']
    
    # Try exact matches first
    active_mask = df['status'].str.lower().isin(active_statuses)
    active_count = active_mask.sum()
    
    if active_count == 0:
        # Try partial matches
        for status in active_statuses:
            partial_mask = df['status'].str.lower().str.contains(status, na=False)
            if partial_mask.sum() > 0:
                active_mask = partial_mask
                active_count = active_mask.sum()
                print(f"   Found active plants using partial match: '{status}'")
                break
    
    if active_count == 0:
        print("   No active plants found with standard status values")
        print("   Available status values:", df['status'].unique())
        # For now, let's use all plants and let user decide
        active_df = df.copy()
        print("   Using all plants (no filtering applied)")
    else:
        active_df = df[active_mask].copy()
        print(f"   Found {active_count} active plants out of {len(df)} total")
    
    return active_df

def load_template_info():
    """Load template GeoTIFF information"""
    print(f"Loading template GeoTIFF: {TEMPLATE_TIFF.name}...")
    
    try:
        with rasterio.open(TEMPLATE_TIFF) as src:
            template_info = {
                'crs': src.crs,
                'transform': src.transform,
                'bounds': src.bounds,
                'width': src.width,
                'height': src.height,
                'profile': src.profile.copy()
            }
            
            print(f"   CRS: {template_info['crs']}")
            print(f"   Bounds: {template_info['bounds']}")
            print(f"   Dimensions: {template_info['width']} x {template_info['height']}")
            print(f"   Transform: {template_info['transform']}")
            
            return template_info
            
    except Exception as e:
        print(f"   Error loading template: {e}")
        return None

def rasterize_asset_data(df, template_info):
    """Rasterize asset data to template grid"""
    if df is None or template_info is None:
        return None, None
    
    print("Rasterizing asset data...")
    
    # Clean and prepare coordinate data
    print("   Cleaning coordinate data...")
    
    # Remove rows with missing coordinates or capacity
    clean_df = df.dropna(subset=['Latitude', 'Longitude', 'Capacity'])
    print(f"   Removed {len(df) - len(clean_df)} rows with missing data")
    
    # Convert capacity to numeric
    clean_df['Capacity'] = pd.to_numeric(clean_df['Capacity'], errors='coerce')
    clean_df = clean_df.dropna(subset=['Capacity'])
    print(f"   Final dataset: {len(clean_df)} assets")
    
    # Get coordinates
    lons = clean_df['Longitude'].values
    lats = clean_df['Latitude'].values
    capacities = clean_df['Capacity'].values
    
    print(f"   Longitude range: {lons.min():.4f} to {lons.max():.4f}")
    print(f"   Latitude range: {lats.min():.4f} to {lats.max():.4f}")
    print(f"   Capacity range: {capacities.min():.2f} to {capacities.max():.2f} MW")
    
    # Initialize output arrays
    width = template_info['width']
    height = template_info['height']
    transform = template_info['transform']
    
    count_array = np.zeros((height, width), dtype=np.int16)
    capacity_array = np.zeros((height, width), dtype=np.float32)
    
    print("   Converting coordinates to pixel indices...")
    
    # Convert lat/lon to pixel coordinates
    pixel_coords = []
    valid_indices = []
    
    # Import pyproj for coordinate transformation
    try:
        from pyproj import Transformer
        transformer = Transformer.from_crs("EPSG:4326", template_info['crs'], always_xy=True)
        print(f"   Using coordinate transformation: WGS84 -> {template_info['crs']}")
    except ImportError:
        print("   pyproj not available, assuming coordinates are already in template CRS")
        transformer = None
    
    for i, (lon, lat) in enumerate(zip(lons, lats)):
        # Transform coordinates if needed
        if transformer is not None:
            try:
                # Transform from WGS84 to template CRS
                x, y = transformer.transform(lon, lat)
            except Exception as e:
                print(f"   Coordinate transformation failed for point {i}: {e}")
                continue
        else:
            # Assume coordinates are already in template CRS
            x, y = lon, lat
        
        # Use rasterio's transform to convert to pixel coordinates
        col, row = ~transform * (x, y)
        col, row = int(col), int(row)
        
        # Check if coordinates are within bounds
        if 0 <= col < width and 0 <= row < height:
            pixel_coords.append((row, col))
            valid_indices.append(i)
        else:
            # Skip points outside the template bounds
            continue
    
    print(f"   {len(valid_indices)} assets fall within template bounds")
    
    # Aggregate data per pixel
    print("   Aggregating data per pixel...")
    
    for idx, (row, col) in enumerate(pixel_coords):
        original_idx = valid_indices[idx]
        capacity = capacities[original_idx]
        
        # Add to count (each asset = 1)
        count_array[row, col] += 1
        
        # Add to capacity sum
        capacity_array[row, col] += capacity
    
    # Calculate statistics
    pixels_with_assets = np.count_nonzero(count_array)
    total_capacity = np.sum(capacity_array)
    max_pixel_count = np.max(count_array)
    max_pixel_capacity = np.max(capacity_array)
    
    print(f"   Pixels with assets: {pixels_with_assets:,}")
    print(f"   Total capacity: {total_capacity:,.2f} MW")
    print(f"   Max assets per pixel: {max_pixel_count}")
    print(f"   Max capacity per pixel: {max_pixel_capacity:.2f} MW")
    
    return count_array, capacity_array

def save_raster_data(count_array, capacity_array, template_info):
    """Save rasterized data to GeoTIFF files"""
    if count_array is None or capacity_array is None or template_info is None:
        return False
    
    print("Saving raster data...")
    
    # Create output directory
    OUTPUT_DIR.mkdir(exist_ok=True)
    
    # Prepare profile for output
    profile = template_info['profile'].copy()
    profile.update({
        'dtype': 'int16',
        'count': 1,
        'compress': 'lzw',
        'nodata': None
    })
    
    # Save count raster
    print(f"   Saving count raster: {OUTPUT_COUNT.name}")
    try:
        with rasterio.open(OUTPUT_COUNT, 'w', **profile) as dst:
            dst.write(count_array, 1)
            dst.update_tags(
                title="FA Asset Count per Pixel",
                description="Count of active assets per 1x1 km pixel",
                source="FA Sample Data",
                processing="Rasterized from Excel coordinates",
                units="count"
            )
        print(f"   Count raster saved: {OUTPUT_COUNT}")
    except Exception as e:
        print(f"   Error saving count raster: {e}")
        return False
    
    # Save capacity raster
    print(f"   Saving capacity raster: {OUTPUT_CAPACITY.name}")
    try:
        profile.update({'dtype': 'float32'})
        with rasterio.open(OUTPUT_CAPACITY, 'w', **profile) as dst:
            dst.write(capacity_array, 1)
            dst.update_tags(
                title="FA Asset Capacity per Pixel",
                description="Sum of active asset capacity per 1x1 km pixel",
                source="FA Sample Data",
                processing="Rasterized from Excel coordinates",
                units="MW"
            )
        print(f"   Capacity raster saved: {OUTPUT_CAPACITY}")
    except Exception as e:
        print(f"   Error saving capacity raster: {e}")
        return False
    
    return True

def create_summary_report(df, clean_df, count_array, capacity_array, template_info):
    """Create a summary report of the processing"""
    if df is None or count_array is None:
        return
    
    print("\n" + "=" * 60)
    print("Processing summary")
    print("=" * 60)
    
    print(f"Input Excel file: {INPUT_EXCEL.name}")
    print(f"Template GeoTIFF: {TEMPLATE_TIFF.name}")
    print(f"Output count raster: {OUTPUT_COUNT.name}")
    print(f"Output capacity raster: {OUTPUT_CAPACITY.name}")
    print("")
    
    print(f"Data processing:")
    print(f"  - Total records in Excel: {len(df)}")
    print(f"  - Records after cleaning: {len(clean_df)}")
    print(f"  - Assets within template bounds: {np.count_nonzero(count_array)}")
    print("")
    
    print(f"Raster statistics:")
    pixels_with_assets = np.count_nonzero(count_array)
    total_pixels = count_array.size
    total_capacity = np.sum(capacity_array)
    
    print(f"  - Pixels with assets: {pixels_with_assets:,}")
    print(f"  - Total pixels: {total_pixels:,}")
    print(f"  - Coverage: {(pixels_with_assets / total_pixels) * 100:.4f}%")
    print(f"  - Total capacity: {total_capacity:,.2f} MW")
    print(f"  - Max assets per pixel: {np.max(count_array)}")
    print(f"  - Max capacity per pixel: {np.max(capacity_array):.2f} MW")
    print("")
    
    print(f"Template alignment:")
    print(f"  - CRS: {template_info['crs']}")
    print(f"  - Bounds: {template_info['bounds']}")
    print(f"  - Resolution: 1x1 km")
    print(f"  - Dimensions: {template_info['width']} x {template_info['height']}")

def main():
    """Main processing function"""
    print("FA Asset-level Data Preprocessing")
    print("=" * 60)
    
    # Step 1: Load Excel data
    print("\nStep 1: Loading Excel data...")
    df = load_excel_data()
    
    if df is None:
        print("Failed to load Excel data. Exiting.")
        return
    
    # Step 2: Filter active plants
    print("\nStep 2: Filtering active plants...")
    active_df = filter_active_plants(df)
    
    if active_df is None:
        print("Failed to filter active plants. Exiting.")
        return
    
    # Step 3: Load template information
    print("\nStep 3: Loading template GeoTIFF...")
    template_info = load_template_info()
    
    if template_info is None:
        print("Failed to load template. Exiting.")
        return
    
    # Step 4: Rasterize asset data
    print("\nStep 4: Rasterizing asset data...")
    count_array, capacity_array = rasterize_asset_data(active_df, template_info)
    
    if count_array is None:
        print("Failed to rasterize data. Exiting.")
        return
    
    # Step 5: Save raster data
    print("\nStep 5: Saving raster data...")
    success = save_raster_data(count_array, capacity_array, template_info)
    
    if not success:
        print("Failed to save raster data. Exiting.")
        return
    
    # Step 6: Create summary report
    create_summary_report(df, active_df, count_array, capacity_array, template_info)
    
    print("\nProcessing complete.")
    print("Output files:")
    print(f"   Count raster: {OUTPUT_COUNT}")
    print(f"   Capacity raster: {OUTPUT_CAPACITY}")

if __name__ == "__main__":
    main()
