"""
Dataset: FAO GAUL 2015 level-0 (ee.FeatureCollection("FAO/GAUL_SIMPLIFIED_500m/2015/level0")).
Purpose: Create a 1 km binary land mask (South America) as a backbone GeoTIFF.
Overview: Authenticates with Google Earth Engine, dissolves all South American
          countries into a single polygon, burns it into a 1 km raster in EPSG:3857,
          and exports a float GeoTIFF with on-continent pixels set to 1 and off-continent
          pixels set to 0.
Usage: export EE_PROJECT_ID=<your-project-id> && python "scripts/data extraction/backbone_export"
"""

import os
from typing import Optional

import ee

PROJECT_ID = os.environ.get("EE_PROJECT_ID")
EXPORT_FOLDER = "GEE_exports"
EXPORT_FILENAME = "backbone_GEE"
EXPORT_DESCRIPTION = "SouthAmerica_backbone_1km"
CRS = "EPSG:3857"
KM = 1000
MAX_PIXELS = 1e13
GAUL_COLLECTION = "FAO/GAUL_SIMPLIFIED_500m/2015/level0"

SOUTH_AMERICA_COUNTRIES = [
    "Argentina",
    "Bolivia",
    "Brazil",
    "Chile",
    "Colombia",
    "Ecuador",
    "French Guiana",
    "Guyana",
    "Paraguay",
    "Peru",
    "Suriname",
    "Uruguay",
    "Venezuela",
]


def initialize_earth_engine(project_id: Optional[str] = None) -> None:
    """Authenticate and initialize Earth Engine with an optional project."""
    try:
        if project_id:
            ee.Initialize(project=project_id)
        else:
            ee.Initialize()
        print("Earth Engine initialized.")
    except Exception as exc:
        print(f"Initialization failed: {exc}")
        print("Attempting interactive authentication...")
        ee.Authenticate()
        if project_id:
            ee.Initialize(project=project_id)
        else:
            ee.Initialize()
        print("Earth Engine initialized after authentication.")


def get_south_america_geometry() -> ee.Geometry:
    """Return a dissolved South America geometry using GAUL level-0 boundaries."""
    countries = ee.FeatureCollection(GAUL_COLLECTION)
    region_fc = countries.filter(ee.Filter.inList("ADM0_NAME", SOUTH_AMERICA_COUNTRIES))
    region = region_fc.geometry().dissolve()
    print("South America geometry assembled from GAUL.")
    return region


def build_backbone_image(region: ee.Geometry) -> ee.Image:
    """Create a float image with South America pixels set to 1 and others to 0."""
    backbone = (
        ee.Image.constant(1)
        .toFloat()
        .clip(region)
        .unmask(0)
        .rename("backbone")
    )

    print("Backbone image prepared (1 for land, 0 outside).")
    return backbone


def export_backbone_image(image: ee.Image, region: ee.Geometry) -> None:
    """Export the backbone land mask to Google Drive."""
    export_region = region.bounds()

    task = ee.batch.Export.image.toDrive(
        image=image,
        description=EXPORT_DESCRIPTION,
        folder=EXPORT_FOLDER,
        fileNamePrefix=EXPORT_FILENAME,
        region=export_region,
        crs=CRS,
        scale=KM,
        maxPixels=MAX_PIXELS,
        fileFormat="GeoTIFF",
        formatOptions={"cloudOptimized": True, "noData": -9999},
    )

    task.start()
    print("Export task started:", task.id)


def main() -> None:
    initialize_earth_engine(PROJECT_ID)
    region = get_south_america_geometry()
    backbone_image = build_backbone_image(region)
    export_backbone_image(backbone_image, region)
    print(
        "Backbone export script completed. Monitor the Tasks tab in the EE Code Editor "
        "or ee.batch.Task.list()."
    )


if __name__ == "__main__":
    main()

