"""
MODIS Burned Area (MCD64A1) â†’ 1 km burned area (South America, 2000-2024)
Method: downsample first (1 km, EPSG:3857, bilinear), then sum across the year.

Outputs: 25 GeoTIFFs (burned_area_2000_*, burned_area_2001_*, ..., burned_area_2024_*), 
float32, clipped to South America.
"""

import ee
ee.Authenticate()   # Opens a browser for Google login

# ----------------------------
# 0) Auth & init
# ----------------------------
# First run: ee.Authenticate()
# If you use a specific EE project, pass project="your-ee-project" to Initialize.
# Use your project ID
PROJECT_ID = 'master-thesis-473316'

try:
    ee.Initialize(project=PROJECT_ID)
    print("âœ… Earth Engine initialized successfully with project:", PROJECT_ID)
except Exception as e:
    print(f"âŒ Initialization failed: {e}")
    print("ğŸ” Attempting authentication...")
    ee.Authenticate()
    try:
        ee.Initialize(project=PROJECT_ID)
        print("âœ… Earth Engine initialized after authentication with project:", PROJECT_ID)
    except Exception as e2:
        print(f"âŒ Still failed: {e2}")
        print("ğŸ’¡ You may need to:")
        print("   1. Enable Earth Engine API in your Google Cloud Project")
        print("   2. Check if project ID is correct:", PROJECT_ID)
        print("   3. Verify you have access to the project")
        exit(1)

# ----------------------------
# 1) Study area (South America)
# ----------------------------
countries = ee.FeatureCollection('USDOS/LSIB_SIMPLE/2017')
region_fc = countries.filter(ee.Filter.inList('wld_rgn', ['South America']))
region = region_fc.geometry()
export_region = region.bounds()

# ----------------------------
# 2) Settings
# ----------------------------
CRS = 'EPSG:3857'
KM = 1000
# MODIS Burned Area dataset
BURNED_AREA = ee.ImageCollection('MODIS/061/MCD64A1')
# Burn Date band contains Julian day of burn (1-366), with 0 for no burn
BURN_BAND = 'BurnDate'

def rename_burn_band(img: ee.Image, prefix: str) -> ee.Image:
    """Rename burn date band with a prefix."""
    return img.select(BURN_BAND).rename(f"{prefix}_burn_date")

# ----------------------------
# 3) Process burned area data per year
# ----------------------------
def process_burned_area_year(start: str, end: str, prefix: str) -> ee.Image:
    # Filter to window + AOI + burn date band
    coll = (
        BURNED_AREA.filterDate(start, end)
                   .filterBounds(region)
                   .select(BURN_BAND)
                   .map(lambda img: (
                       img
                         .resample('bilinear')                         # bilinear resampling
                         .reproject(crs=CRS, scale=KM)                 # force 1 km @ EPSG:3857
                   ))
    )
    
    # For burned area, we want to sum the burn dates across the year
    # This gives us total burned area for the year (non-zero pixels indicate burns)
    # We'll also create a binary mask for burned vs unburned
    burn_date_sum = ee.ImageCollection(coll).sum().clip(region).unmask(0).toFloat()
    
    # Create binary burned area mask (1 if burned anywhere in year, 0 otherwise)
    burned_mask = burn_date_sum.gt(0).clip(region).unmask(0).toFloat()
    
    # Create composite with both burn date sum and binary mask
    composite = burn_date_sum.addBands(burned_mask).rename([f"{prefix}_burn_date", f"{prefix}_burned_mask"])
    
    return composite

# ----------------------------
# 4) Process data for years 2000-2024
# ----------------------------
years = list(range(2000, 2025))  # 2000 to 2024 inclusive
images = {}

for year in years:
    start_date = f'{year}-01-01'
    end_date = f'{year+1}-01-01'
    prefix = f'burned_area_{year}'
    
    print(f'Processing year {year}...')
    images[year] = process_burned_area_year(start_date, end_date, prefix)

# (Optional) sanity print for first year
print('Bands:', images[2000].bandNames().getInfo())

# ----------------------------
# 5) Export to Google Drive for all years
# ----------------------------
tasks = []
for year in years:
    task = ee.batch.Export.image.toDrive(
        image=images[year],
        description=f'Burned_Area_SA_1km_{year}',
        folder='GEE_exports',                 # change or remove as you like
        fileNamePrefix=f'Burned_Area_SA_1km_{year}',
        region=export_region,
        crs=CRS,
        scale=KM,
        maxPixels=1e13
    )
    task.start()
    tasks.append(task)
    print(f'Export started for {year}:', task.id)

# ----------------------------
# (Optional) Export to Cloud Storage instead of Drive
# ----------------------------
# tasks_gcs = []
# for year in years:
#     task_gcs = ee.batch.Export.image.toCloudStorage(
#         image=images[year],
#         description=f'Burned_Area_SA_1km_{year}_gcs',
#         bucket='your-gcs-bucket',
#         fileNamePrefix=f'gee/Burned_Area_SA_1km_{year}',
#         region=export_region,
#         crs=CRS,
#         scale=KM,
#         maxPixels=1e13
#     )
#     task_gcs.start()
#     tasks_gcs.append(task_gcs)
#     print(f'GCS export started for {year}:', task_gcs.id)

print(f"\nâœ… Started {len(tasks)} export tasks for burned area data (2000-2024)")
print("ğŸ“Š Each export contains 2 bands:")
print("   - burn_date: Sum of Julian burn days (0 = no burn, >0 = burned)")
print("   - burned_mask: Binary mask (1 = burned anywhere in year, 0 = never burned)")
print("ğŸ” Check your Google Drive 'GEE_exports' folder for results")
