"""
Power Plants â†’ 1 km raster (South America, 2024)
Dataset: WRI/GPPD/power_plants (Global Power Plant Database)
Method: rasterize features, downsample to 1 km (EPSG:3857), clip to South America.

Outputs: 1 GeoTIFF (powerplants_*), float32, clipped to South America.
"""

import ee
ee.Authenticate()   # Opens a browser for Google login

# ----------------------------
# 0) Auth & init
# ----------------------------
# First run: ee.Authenticate()
# If you use a specific EE project, pass project="your-ee-project" to Initialize.
# Use your project ID
PROJECT_ID = 'master-thesis-473316'

try:
    ee.Initialize(project=PROJECT_ID)
    print("âœ… Earth Engine initialized successfully with project:", PROJECT_ID)
except Exception as e:
    print(f"âŒ Initialization failed: {e}")
    print("ðŸ” Attempting authentication...")
    ee.Authenticate()
    try:
        ee.Initialize(project=PROJECT_ID)
        print("âœ… Earth Engine initialized after authentication with project:", PROJECT_ID)
    except Exception as e2:
        print(f"âŒ Still failed: {e2}")
        print("ðŸ’¡ You may need to:")
        print("   1. Enable Earth Engine API in your Google Cloud Project")
        print("   2. Check if project ID is correct:", PROJECT_ID)
        print("   3. Verify you have access to the project")
        exit(1)

# ----------------------------
# 1) Study area (South America)
# ----------------------------
countries = ee.FeatureCollection('USDOS/LSIB_SIMPLE/2017')
region_fc = countries.filter(ee.Filter.inList('wld_rgn', ['South America']))
region = region_fc.geometry()
export_region = region.bounds()

# ----------------------------
# 2) Settings
# ----------------------------
CRS = 'EPSG:3857'
KM = 1000

# Load the Global Power Plant Database dataset
GPPD = ee.FeatureCollection('WRI/GPPD/power_plants')

# ----------------------------
# 3) Process and rasterize (most recent data)
# ----------------------------
def process_data() -> ee.Image:
    """
    Filter GPPD features within South America bounds, rasterize to 1km resolution.
    Uses the most recent data available in the dataset.
    Creates both count and fuel type rasters.
    """
    # Filter to features within South America bounds (no year filtering)
    filtered = GPPD.filterBounds(region)
    
    # Rasterize the features - count density of power plants
    # Add a constant numeric property for counting, then rasterize
    filtered_with_count = filtered.map(lambda f: f.set('count', 1))
    
    rasterized_count = filtered_with_count.reduceToImage(
        properties=['count'],
        reducer=ee.Reducer.sum()  # sum of 1s = count of features
    ).rename('powerplant_count')
    
    # Create fuel type raster using fuel1 attribute
    # Map fuel types to numeric codes for rasterization
    def map_fuel_type(feature):
        fuel1 = ee.String(feature.get('fuel1'))
        # Create numeric codes for different fuel types
        fuel_code = ee.Algorithms.If(
            fuel1.equals('Coal'), 1,
            ee.Algorithms.If(fuel1.equals('Gas'), 2,
            ee.Algorithms.If(fuel1.equals('Oil'), 3,
            ee.Algorithms.If(fuel1.equals('Hydro'), 4,
            ee.Algorithms.If(fuel1.equals('Nuclear'), 5,
            ee.Algorithms.If(fuel1.equals('Solar'), 6,
            ee.Algorithms.If(fuel1.equals('Wind'), 7,
            ee.Algorithms.If(fuel1.equals('Biomass'), 8,
            ee.Algorithms.If(fuel1.equals('Geothermal'), 9,
            ee.Algorithms.If(fuel1.equals('Waste'), 10, 0))))))))))  # Other/Unknown = 0
        return feature.set('fuel_code', fuel_code)
    
    filtered_with_fuel = filtered.map(map_fuel_type)
    
    # Rasterize fuel types (use mode to get dominant fuel type per pixel)
    rasterized_fuel = filtered_with_fuel.reduceToImage(
        properties=['fuel_code'],
        reducer=ee.Reducer.mode()  # mode gives the most common fuel type per pixel
    ).rename('fuel_type')
    
    # Combine both rasters
    combined = rasterized_count.addBands(rasterized_fuel)
    
    # Reproject to 1km resolution
    img = (
        combined
        .unmask(0)
        .reproject(crs=CRS, scale=KM)
        .clip(region)
        .toFloat()
    )
    
    return img

# ----------------------------
# 4) Process data (most recent)
# ----------------------------
print('Processing most recent data...')
image = process_data()

# (Optional) sanity print
print('Sample bands:', image.bandNames().getInfo())
print('Sample projection:', image.projection().getInfo())

# Print fuel type mapping for reference
print('\nFuel type codes:')
print('0: Other/Unknown')
print('1: Coal')
print('2: Gas')
print('3: Oil')
print('4: Hydro')
print('5: Nuclear')
print('6: Solar')
print('7: Wind')
print('8: Biomass')
print('9: Geothermal')
print('10: Waste')

# ----------------------------
# 5) Export to Google Drive (most recent data)
# ----------------------------
task = ee.batch.Export.image.toDrive(
    image=image,
    description='GPPD_powerplants_with_fuel_SA_1km',
    folder='GEE_exports',                 # change or remove as you like
    fileNamePrefix='GPPD_powerplants_with_fuel_SA_1km',
    region=export_region,
    crs=CRS,
    scale=KM,
    maxPixels=1e13
)
task.start()
print('Export started:', task.id)

print(f'\nâœ… Export task has been started!')
print('ðŸ“Š Check progress at: https://code.earthengine.google.com/tasks')

# ----------------------------
# (Optional) Export to Cloud Storage instead of Drive
# ----------------------------
# task_gcs = ee.batch.Export.image.toCloudStorage(
#     image=image,
#     description='GPPD_powerplants_SA_1km_gcs',
#     bucket='your-gcs-bucket',
#     fileNamePrefix='gee/GPPD_powerplants_SA_1km',
#     region=export_region,
#     crs=CRS,
#     scale=KM,
#     maxPixels=1e13
# )
# task_gcs.start()
# print('GCS export started:', task_gcs.id)
