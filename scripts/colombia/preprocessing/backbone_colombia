#!/usr/bin/env python3
"""
Reproject Colombia mask onto South America backbone grid.

Purpose:
    Reprojects colombia_GEE.tif onto the South America backbone grid
    (backbone.tif) to create a Colombia mask aligned with the SA reference grid.

Inputs:
    - data/ready/backbone/backbone.tif (South America backbone, defines reference grid)
    - data/ready/backbone/colombia_GEE.tif (Colombia mask in original grid)

Outputs:
    - data/ready/backbone/colombia_backbone.tif (Colombia mask reprojected to SA grid)
    - data/ready/backbone/colombia_backbone_sa_grid.tif (Colombia mask * SA backbone)
"""

from pathlib import Path
import warnings

import numpy as np
import rasterio
from rasterio.enums import Resampling
from rasterio.warp import reproject

warnings.filterwarnings("ignore")


# Paths
PROJECT_ROOT = Path(__file__).resolve().parents[3]
BACKBONE_DIR = PROJECT_ROOT / "data" / "ready" / "backbone"

SA_BACKBONE_PATH = BACKBONE_DIR / "backbone.tif"
COLOMBIA_INPUT_PATH = BACKBONE_DIR / "colombia_GEE.tif"
COLOMBIA_OUTPUT_PATH = BACKBONE_DIR / "colombia_backbone.tif"
COLOMBIA_SA_GRID_PATH = BACKBONE_DIR / "colombia_backbone_sa_grid.tif"


def load_sa_backbone() -> tuple[rasterio.DatasetReader, dict]:
    """Load South America backbone to get reference grid parameters."""
    if not SA_BACKBONE_PATH.exists():
        raise FileNotFoundError(
            f"Missing SA backbone raster at {SA_BACKBONE_PATH}. "
            "Please ensure backbone.tif exists."
        )
    
    src = rasterio.open(SA_BACKBONE_PATH)
    profile = src.profile.copy()
    
    print(f"Loaded SA backbone: shape={src.shape}, CRS={src.crs}, transform={src.transform}")
    print(f"  Height: {src.height}, Width: {src.width}")
    
    return src, profile


def reproject_colombia_mask(sa_src: rasterio.DatasetReader, sa_profile: dict) -> np.ndarray:
    """Reproject Colombia mask onto SA grid."""
    print(f"\nReprojecting {COLOMBIA_INPUT_PATH.name} to SA grid...")
    
    if not COLOMBIA_INPUT_PATH.exists():
        raise FileNotFoundError(
            f"Missing Colombia mask at {COLOMBIA_INPUT_PATH}. "
            "Please ensure colombia_GEE.tif exists."
        )
    
    with rasterio.open(COLOMBIA_INPUT_PATH) as colombia_src:
        print(f"  Source: shape={colombia_src.shape}, CRS={colombia_src.crs}")
        
        # Create destination array with SA grid dimensions
        dst_shape = (sa_profile["height"], sa_profile["width"])
        dst = np.zeros(dst_shape, dtype=np.float32)
        
        # Handle nodata carefully: don't treat valid 0s as nodata
        # If source nodata is 0 or None, use None to treat all values (including 0) as valid
        # Otherwise use the source's nodata value
        src_nodata = None if (colombia_src.nodata is None or colombia_src.nodata == 0) else colombia_src.nodata
        
        # Reproject Colombia mask to SA grid
        # Use dst_nodata=None to avoid treating 0s as nodata (0 is a valid mask value)
        reproject(
            source=rasterio.band(colombia_src, 1),
            destination=dst,
            src_transform=colombia_src.transform,
            src_crs=colombia_src.crs,
            src_nodata=src_nodata,
            dst_transform=sa_profile["transform"],
            dst_crs=sa_profile["crs"],
            resampling=Resampling.nearest,
            dst_nodata=None,  # Don't use 0 as nodata since 0 is a valid mask value
        )
        
        # Force values to {0, 1} using threshold >0.5
        colombia_mask_sa = np.where(dst > 0.5, 1, 0).astype(np.uint8)
        
        print(f"  Reprojected: shape={colombia_mask_sa.shape}")
        print(f"  Colombia pixels: {(colombia_mask_sa == 1).sum():,}")
        print(f"  Outside pixels: {(colombia_mask_sa == 0).sum():,}")
        
        return colombia_mask_sa


def save_colombia_backbone(colombia_mask: np.ndarray, sa_profile: dict, sa_src: rasterio.DatasetReader) -> None:
    """Save reprojected Colombia mask with SA profile."""
    print(f"\nSaving {COLOMBIA_OUTPUT_PATH.name}...")
    
    # Update profile for binary mask
    output_profile = sa_profile.copy()
    output_profile.update(
        dtype="uint8",
        count=1,
        nodata=None,
        compress="lzw",
    )
    
    with rasterio.open(COLOMBIA_OUTPUT_PATH, "w", **output_profile) as dst:
        dst.write(colombia_mask, 1)
    
    # Sanity check: verify output grid matches SA backbone
    with rasterio.open(COLOMBIA_OUTPUT_PATH) as output_src:
        assert output_src.shape == sa_src.shape, (
            f"Output shape {output_src.shape} does not match SA backbone shape {sa_src.shape}"
        )
        assert output_src.crs == sa_src.crs, (
            f"Output CRS {output_src.crs} does not match SA backbone CRS {sa_src.crs}"
        )
        assert np.allclose(output_src.transform, sa_src.transform, atol=1e-6), (
            f"Output transform {output_src.transform} does not match SA backbone transform {sa_src.transform}"
        )
    
    print(f"  Saved: {COLOMBIA_OUTPUT_PATH}")
    print(f"  Colombia pixels: {(colombia_mask == 1).sum():,}")
    print(f"  Grid sanity check passed (shape, CRS, transform match SA backbone)")


def create_colombia_sa_grid(colombia_mask: np.ndarray, sa_src: rasterio.DatasetReader) -> np.ndarray:
    """Create final backbone: colombia_mask * (sa_backbone == 1)."""
    print(f"\nCreating combined mask: Colombia mask * SA backbone...")
    
    # Read SA backbone array
    sa_backbone = sa_src.read(1)
    
    # Create combined mask: colombia_mask * (sa_backbone == 1)
    colombia_sa_grid = colombia_mask * (sa_backbone == 1).astype(np.uint8)
    
    print(f"  Colombia pixels in SA: {(colombia_sa_grid == 1).sum():,}")
    
    return colombia_sa_grid


def save_colombia_sa_grid(colombia_sa_grid: np.ndarray, sa_profile: dict, sa_src: rasterio.DatasetReader) -> None:
    """Save combined Colombia-SA grid mask."""
    print(f"\nSaving {COLOMBIA_SA_GRID_PATH.name}...")
    
    # Update profile for binary mask
    output_profile = sa_profile.copy()
    output_profile.update(
        dtype="uint8",
        count=1,
        nodata=None,
        compress="lzw",
    )
    
    with rasterio.open(COLOMBIA_SA_GRID_PATH, "w", **output_profile) as dst:
        dst.write(colombia_sa_grid, 1)
    
    # Sanity check: verify output grid matches SA backbone
    with rasterio.open(COLOMBIA_SA_GRID_PATH) as output_src:
        assert output_src.shape == sa_src.shape, (
            f"Output shape {output_src.shape} does not match SA backbone shape {sa_src.shape}"
        )
        assert output_src.crs == sa_src.crs, (
            f"Output CRS {output_src.crs} does not match SA backbone CRS {sa_src.crs}"
        )
        assert np.allclose(output_src.transform, sa_src.transform, atol=1e-6), (
            f"Output transform {output_src.transform} does not match SA backbone transform {sa_src.transform}"
        )
    
    print(f"  Saved: {COLOMBIA_SA_GRID_PATH}")
    print(f"  Colombia pixels in SA: {(colombia_sa_grid == 1).sum():,}")
    print(f"  Grid sanity check passed (shape, CRS, transform match SA backbone)")


def main() -> None:
    print("Colombia Backbone Reprojection")
    print("=" * 60)
    print(f"SA backbone: {SA_BACKBONE_PATH}")
    print(f"Colombia input: {COLOMBIA_INPUT_PATH}")
    print(f"Colombia output: {COLOMBIA_OUTPUT_PATH}")
    print(f"Combined output: {COLOMBIA_SA_GRID_PATH}")
    
    # Load SA backbone for reference grid
    sa_src, sa_profile = load_sa_backbone()
    
    try:
        # Reproject Colombia mask to SA grid
        colombia_mask_sa = reproject_colombia_mask(sa_src, sa_profile)
        
        # Save reprojected Colombia mask
        save_colombia_backbone(colombia_mask_sa, sa_profile, sa_src)
        
        # Create and save combined mask (optional)
        colombia_sa_grid = create_colombia_sa_grid(colombia_mask_sa, sa_src)
        save_colombia_sa_grid(colombia_sa_grid, sa_profile, sa_src)
        
        print("\n" + "=" * 60)
        print("Processing complete.")
        print(f"  Created: {COLOMBIA_OUTPUT_PATH}")
        print(f"  Created: {COLOMBIA_SA_GRID_PATH}")
        
    finally:
        sa_src.close()


if __name__ == "__main__":
    main()

